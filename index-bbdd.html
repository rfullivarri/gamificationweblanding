<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirmacion BBDD & Daily Quest</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/bbdd.css?v=6">
</head>
<body>
  <!-- Modal overlay: en desktop se usa como modal; en mobile ocupa toda la pantalla -->
  <div id="bbdd-overlay" class="bbdd-overlay hidden">
    <div class="bbdd-panel">
      <header class="bbdd-header">
        <button id="bbdd-back" class="btn ghost">‚Üê Volver</button>
        <h1>‚öôÔ∏è Conf BBDD & Daily Quest</h1>
        <div class="spacer"></div>
        <button id="bbdd-confirm" class="btn primary">Confirmar cambios ‚úì</button>
      </header>

      <section class="bbdd-tip gj-info collapsed" id="bbdd-tip">
        <b>üìå IMPORTANTE ‚Äì C√≥mo deben ser tus Tasks</b><br/>
        ‚úîÔ∏è Que puedas completarlas en un solo d√≠a.<br/>
        ‚úîÔ∏è Deben ser claras, espec√≠ficas y medibles.<br/>
        üö´ Evit√° frases vagas como ‚Äúhacer algo saludable‚Äù.<br/>
        üéØ Mejor: ‚ÄúPreparar una comida saludable‚Äù o ‚ÄúMeditar 10 minutos‚Äù.<br/>
        ‚ôªÔ∏è Ideal si pod√©s repetirlas cada semana.
        <div class="legend">
          <span>‚ú® Mejorar: pulir esta misma task</span>
          <span>üîÅ Modificar: proponer una distinta manteniendo Pilar/Rasgo/Stat/Dificultad</span>
        </div>
      
        <!-- Bot√≥n de colapsar/expandir -->
        <button type="button" class="tip-toggle btn ghost small" aria-expanded="false">Mostrar gu√≠a</button>
        <span class="tip-fade" aria-hidden="true"></span>
      </section>

      <section class="bbdd-tools">
        <div class="left">
          <button id="add-row" class="btn ghost">+ Fila</button>
          <span id="dirty-indicator" class="dot hidden">‚óè Cambios sin guardar</span>
        </div>
      
        <div class="center">
          <input id="search" class="input" placeholder="Filtrar‚Ä¶ (ej: 'ayuno', 'Mind')" />
        </div>
      
        <div class="right">
          <button id="bbdd-ai" class="btn ghost" title="Enviar a IA">‚ú® AI (Coming Soon)</button>
          <div id="ai-sparkle" class="ai-sparkle" style="display:none;"></div>
        </div>
      </section>

      <section id="table-wrap" class="bbdd-table-wrap">
        <!-- overlay/spinner centrado -->
        <div id="table-spinner" aria-live="polite" aria-busy="true">
          <span class="ring" aria-hidden="true"></span>
          <span class="txt">Cargando tus tareas‚Ä¶</span>
        </div>
      
        <table id="bbdd-table" class="bbdd-table" aria-label="Tabla BBDD">
          <thead>
            <tr>
              <th style="width:110px">Pilares</th>
              <th style="width:160px">Rasgo</th>
              <th style="width:160px">Stats</th>
              <th>Tasks</th>
              <th style="width:120px">Dificultad</th>
              <th style="width:120px">Feedback</th>
              <th style="width:60px"></th>
            </tr>
          </thead>
          <tbody id="bbdd-tbody"><!-- filas din√°micas --></tbody>
        </table>
      </section>

      <footer class="bbdd-footer">
        <small id="status-msg"></small>
        <div class="spacer"></div>
        <button id="close-modal" class="btn ghost">Cerrar</button>
      </footer>
    </div>
  </div>

  <script>
    // Configuraci√≥n de modo:
    // - Si se incluye en el dashboard, setear window.BBDD_MODE="modal" y llamar window.openBBDD(email)
    // - Si se quiere como p√°gina independiente, usar query ?email= y window.BBDD_MODE="page"
    window.BBDD_MODE = window.BBDD_MODE || (matchMedia("(max-width: 768px)").matches ? "page" : "modal");
  </script>
  <script src="js/bbdd.js"></script>
  <script>
  // Navegaci√≥n de vuelta al dashboard si vino con &back=
  (function () {
    const params = new URLSearchParams(location.search);
    const backURL = params.get('back'); // viene urlencodeado por el dashboard

    function goBack() {
      if (backURL) {
        location.href = decodeURIComponent(backURL);
      } else {
        // fallback razonable
        history.length > 1 ? history.back() : (location.href = 'dashboardv3.html');
      }
    }

    // Bot√≥n "Volver" del header (si existe)
    document.getElementById('btn-back')?.addEventListener('click', (e) => {
      e.preventDefault(); goBack();
    });

    // Bot√≥n "Cerrar" del footer (si existe)
    document.getElementById('close-modal')?.addEventListener('click', (e) => {
      e.preventDefault(); goBack();
    });
  })();
</script>

<style id="bbdd-hotfix">
  /* ====== LAYOUT GENERAL ====== */
  .bbdd-overlay{
    position:fixed; inset:0; z-index:9999;
    display:flex; align-items:center; justify-content:center;
    padding:clamp(8px,2vh,24px);
    background: rgba(8,12,28,.55);
    backdrop-filter: blur(16px) saturate(1.08);
    -webkit-backdrop-filter: blur(16px) saturate(1.08);
  }
  .bbdd-panel{
    width:min(1200px,100%);
    height:min(96dvh,100dvh);              /* ocupa casi toda la altura de viewport */
    max-height:96dvh;
    display:grid;
    grid-template-rows: auto /* header */
                         auto /* tip */
                         auto /* tools */
                         1fr  /* tabla */
                         auto /* footer */;
    overflow:hidden;
    border-radius:14px; border:1px solid rgba(122,134,255,.18);
    background: linear-gradient(180deg, rgba(18,22,45,.86), rgba(12,16,35,.80));
    box-shadow: 0 24px 80px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.04);
  }

  /* ====== HEADER STICKY ====== */
  .bbdd-header{
    position:sticky; top:0; z-index:10;
    display:flex; align-items:center; gap:12px;
    padding:12px 16px;
    background: linear-gradient(180deg, rgba(26,31,68,.94), rgba(18,22,45,.90));
    border-bottom:1px solid rgba(122,134,255,.20);
  }
  .bbdd-header h1{ font-size:16px; margin:0; }
  .bbdd-header .spacer{ flex:1; }

  /* ====== TIP COLAPSABLE (por defecto colapsado) ====== */
  .bbdd-tip{
    position:relative;
    margin:12px 16px 0;
    padding:12px 14px 36px; /* espacio para el toggle */
    border:1px solid rgba(122,134,255,.18);
    border-radius:12px;
    background: linear-gradient(180deg, rgba(28,34,74,.6), rgba(20,24,52,.6));
    overflow:auto;
  }
  .bbdd-tip.collapsed{
    max-height:88px;                /* ocupa poco alto por defecto */
    overflow:hidden;
  }
  .bbdd-tip .legend{ display:flex; gap:12px; margin-top:10px; opacity:.9; font-size:.9rem; }
  .bbdd-tip .tip-fade{
    position:absolute; left:0; right:0; bottom:0; height:38px;
    background: linear-gradient(to bottom, transparent, rgba(12,16,35,.96));
    pointer-events:none; display:none;
  }
  .bbdd-tip.collapsed .tip-fade{ display:block; }

  .tip-toggle{
    position:absolute; right:10px; bottom:8px;
    font-size:12px; padding:4px 8px; line-height:1;
  }

  /* ====== TOOLS STICKY ====== */
  .bbdd-tools{
    position:sticky; top:var(--tools-top, 56px); z-index:9;
    display:grid; grid-template-columns: 1fr 1fr 1fr; align-items:center;
    gap:12px; padding:8px 16px;
    background: linear-gradient(180deg, rgba(26,31,68,.92), rgba(20,24,52,.92));
    border-bottom:1px solid rgba(122,134,255,.18);
  }
  .bbdd-tools .left{ display:flex; align-items:center; gap:12px; }
  .bbdd-tools .center{ display:flex; justify-content:center; }
  .bbdd-tools .right{ display:flex; justify-content:flex-end; align-items:center; gap:10px; }

  /* ====== TABLA: ocupa todo el resto y scrollea ====== */
  .bbdd-table-wrap{
    min-height:0;            /* permite que 1fr funcione */
    overflow:auto;
    margin:12px 16px 16px;
    border-radius:12px;
    position:relative;
  }
  #bbdd-table{ width:100%; border-collapse:separate; border-spacing:0; }

  /* header sticky siempre visible al scrollear */
  #bbdd-table thead th{
    position:sticky; top:0; z-index:5;
    padding:8px 10px;
    background: linear-gradient(180deg, rgba(44,52,106,.92), rgba(26,31,68,.94));
    color:#dbe0ff;
    border-bottom:1px solid rgba(122,134,255,.22);
    text-align:left; font-weight:600; white-space:nowrap;
  }
  /* filas un poco m√°s compactas para ver m√°s tareas */
  #bbdd-table tbody td{
    padding:6px 10px; border-bottom:1px solid rgba(122,134,255,.10);
  }

  /* Spinner centrado sobre la tabla */
  #table-spinner{
    position:absolute; inset:0; display:none; z-index:6;
    align-items:center; justify-content:center; gap:12px;
    backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
    background: rgba(10,12,24,.45); color:#ecedff; font-weight:600;
  }
  .bbdd-table-wrap.table-loading #table-spinner{ display:flex; }
  .bbdd-table-wrap.table-loading #bbdd-table{ filter:blur(1px); opacity:.6; pointer-events:none; }

  /* ===== Scrollbar oscuro (WebKit) ===== */
  .bbdd-table-wrap::-webkit-scrollbar{ width:10px; height:10px; }
  .bbdd-table-wrap::-webkit-scrollbar-thumb{
    background: rgba(122,134,255,.28); border-radius:10px; border:2px solid transparent; background-clip: padding-box;
  }
  .bbdd-table-wrap::-webkit-scrollbar-track{ background:transparent; }

  /* ===== FOOTER ===== */
  .bbdd-footer{
    display:flex; align-items:center; gap:12px;
    padding:10px 16px; border-top:1px solid rgba(122,134,255,.18);
    background: linear-gradient(180deg, rgba(20,24,52,.88), rgba(16,20,44,.88));
  }
  .bbdd-footer .spacer{ flex:1; }

  /* ===== Botones peque√±os reutilizados ===== */
  .btn.small{ font-size:12px; padding:6px 10px; }

  /* ===== MOBILE: pantalla completa ===== */
  @media (max-width:768px){
    .bbdd-overlay{ align-items:stretch; padding:0; }
    .bbdd-panel{
      width:100%; height:100dvh; max-height:100dvh; border-radius:0;
      grid-template-rows: auto auto auto 1fr auto;
    }
    .bbdd-tools{ position:sticky; top:0; } /* menos offset */
  }
</style>

<script>
  (function(){
    const btn = document.getElementById('bbdd-back');
    if(!btn) return;
    btn.addEventListener('click', function(e){
      e.preventDefault();
      const u = new URL(location.href);
      const email = (u.searchParams.get('email') || localStorage.getItem('gj_email') || '').trim().toLowerCase();
      const cameFromDash = document.referrer && /dashboard/i.test(document.referrer);
      if (cameFromDash && history.length > 1) { history.back(); return; }
      const dash = new URL('dashboardv3.html', location.origin);
      if (email) dash.searchParams.set('email', email);
      location.href = dash.toString();
    });
  })();
</script>
  
<script>
  (function(){
    // ‚Äî‚Äî Toggle gu√≠a (colapsada por defecto)
    const tip = document.getElementById('bbdd-tip');
    const btn = tip?.querySelector('.tip-toggle');
    function setTip(collapsed){
      tip.classList.toggle('collapsed', collapsed);
      if (btn) btn.setAttribute('aria-expanded', String(!collapsed));
      if (btn) btn.textContent = collapsed ? 'Mostrar gu√≠a' : 'Ocultar gu√≠a';
      calcToolsTop(); // por si cambia la altura
    }
    btn?.addEventListener('click', () => setTip(!tip.classList.contains('collapsed')));
    // inicia colapsada
    if (tip) setTip(true);

    // ‚Äî‚Äî Mantener el toolbar justo debajo del header
    function calcToolsTop(){
      const header = document.querySelector('.bbdd-header');
      const top = header ? header.getBoundingClientRect().height : 56;
      document.documentElement.style.setProperty('--tools-top', top + 'px');
    }
    window.addEventListener('load', calcToolsTop);
    window.addEventListener('resize', calcToolsTop);
    new ResizeObserver(calcToolsTop).observe(document.body);
  })();
</script>
</body>
</html>
