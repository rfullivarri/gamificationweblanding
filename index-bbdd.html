<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirmacion BBDD & Daily Quest</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/bbdd.css?v=6">
</head>
<body>
  <!-- Modal overlay: en desktop se usa como modal; en mobile ocupa toda la pantalla -->
  <div id="bbdd-overlay" class="bbdd-overlay hidden">
    <div class="bbdd-panel">
      <header class="bbdd-header">
        <button id="bbdd-back" class="btn ghost">‚Üê Volver</button>
        <h1>‚öôÔ∏è Conf BBDD & Daily Quest</h1>
        <div class="spacer"></div>
        <button id="bbdd-confirm" class="btn primary">Confirmar cambios ‚úì</button>
      </header>

      <section class="bbdd-tip gj-info collapsed" id="bbdd-tip">
        <b>üìå IMPORTANTE ‚Äì C√≥mo deben ser tus Tasks</b><br/>
        ‚úîÔ∏è Que puedas completarlas en un solo d√≠a.<br/>
        ‚úîÔ∏è Deben ser claras, espec√≠ficas y medibles.<br/>
        üö´ Evit√° frases vagas como ‚Äúhacer algo saludable‚Äù.<br/>
        üéØ Mejor: ‚ÄúPreparar una comida saludable‚Äù o ‚ÄúMeditar 10 minutos‚Äù.<br/>
        ‚ôªÔ∏è Ideal si pod√©s repetirlas cada semana.
        <div class="legend">
          <span>ü™Ñ Mejorar: pulir esta misma task</span>
          <span>üîÅ Modificar: proponer una distinta manteniendo Pilar/Rasgo/Stat/Dificultad</span>
        </div>
      </section>

      <section class="bbdd-tools">
        <div class="left">
          <button id="add-row" class="btn ghost">+ Fila</button>
          <span id="dirty-indicator" class="dot hidden">‚óè Cambios sin guardar</span>
        </div>
      
        <div class="center">
          <input id="search" class="input" placeholder="Filtrar‚Ä¶ (ej: 'ayuno', 'Mind')" />
        </div>
      
        <div class="right">
          <button id="bbdd-ai" class="btn ghost" title="Enviar a IA">‚ú® AI (Coming Soon)</button>
          <div id="ai-sparkle" class="ai-sparkle" style="display:none;"></div>
        </div>
      </section>
      <!-- BARRA FIJA DE NOMBRES DE COLUMNA -->
      <section class="bbdd-columns" aria-hidden="true">
        <div>Pilares</div>
        <div>Rasgo</div>
        <div>Stats</div>
        <div>Tasks</div>
        <div>Dificultad</div>
        <div>Feedback</div>
      </section>
      

      <section id="table-wrap" class="bbdd-table-wrap">
        <!-- overlay/spinner centrado -->
        <div id="table-spinner" aria-live="polite" aria-busy="true">
          <span class="ring" aria-hidden="true"></span>
          <span class="txt">Cargando tus tareas‚Ä¶</span>
        </div>
      
        <table id="bbdd-table" class="bbdd-table" aria-label="Tabla BBDD">
          <colgroup>
            <col class="col-pilar" />
            <col class="col-rasgo" />
            <col class="col-stat" />
            <col class="col-task" />
            <col class="col-dificultad" />
            <col class="col-feedback" />
            <col class="col-eliminar" />
          </colgroup>
                    
          <thead>
            <tr>
              <th style="width:110px">Pilares</th>
              <th style="width:160px">Rasgo</th>
              <th style="width:160px">Stats</th>
              <th>Tasks</th>
              <th style="width:120px">Dificultad</th>
              <th style="width:120px">Feedback</th>
              <th style="width:60px"></th>
            </tr>
          </thead>
          <tbody id="bbdd-tbody"><!-- filas din√°micas --></tbody>
        </table>
      </section>

      <footer class="bbdd-footer">
        <small id="status-msg"></small>
        <div class="spacer"></div>
        <button id="close-modal" class="btn ghost">Cerrar</button>
      </footer>
    </div>
  </div>

  <script>
    // Configuraci√≥n de modo:
    // - Si se incluye en el dashboard, setear window.BBDD_MODE="modal" y llamar window.openBBDD(email)
    // - Si se quiere como p√°gina independiente, usar query ?email= y window.BBDD_MODE="page"
    window.BBDD_MODE = window.BBDD_MODE || (matchMedia("(max-width: 768px)").matches ? "page" : "modal");
  </script>
  <script src="js/bbdd.js"></script>
  <script>
  // Navegaci√≥n de vuelta al dashboard si vino con &back=
  (function () {
    const params = new URLSearchParams(location.search);
    const backURL = params.get('back'); // viene urlencodeado por el dashboard

    function goBack() {
      if (backURL) {
        location.href = decodeURIComponent(backURL);
      } else {
        // fallback razonable
        history.length > 1 ? history.back() : (location.href = 'dashboardv3.html');
      }
    }

    // Bot√≥n "Volver" del header (si existe)
    document.getElementById('btn-back')?.addEventListener('click', (e) => {
      e.preventDefault(); goBack();
    });

    // Bot√≥n "Cerrar" del footer (si existe)
    document.getElementById('close-modal')?.addEventListener('click', (e) => {
      e.preventDefault(); goBack();
    });
  })();
</script>
  

<script>
  (function(){
    const btn = document.getElementById('bbdd-back');
    if(!btn) return;
    btn.addEventListener('click', function(e){
      e.preventDefault();
      const u = new URL(location.href);
      const email = (u.searchParams.get('email') || localStorage.getItem('gj_email') || '').trim().toLowerCase();
      const cameFromDash = document.referrer && /dashboard/i.test(document.referrer);
      if (cameFromDash && history.length > 1) { history.back(); return; }
      const dash = new URL('dashboardv3.html', location.origin);
      if (email) dash.searchParams.set('email', email);
      location.href = dash.toString();
    });
  })();
</script>
<style id="bbdd-hotfix">
  /* ===== Variables (una sola fuente de verdad) ===== */
  :root{
    --col-gap: 5px;            /* separaci√≥n entre columnas */
    /* Ajust√° estos % si quer√©s. Suman ~100% */
    --w-pilar:        10%;
    --w-rasgo:        12%;
    --w-stat:         12%;
    --w-task:         38%;     /* ‚Üì baj√© Task para darle aire a la derecha */
    --w-dificultad:   11%;     /* ‚Üë m√°s ancho para el select */
    --w-feedback:     11%;     /* ‚Üë m√°s ancho para los 2 botones + eliminar */
    --w-eliminar:     6%;
  }

  /* ===== Overlay + Panel scrolleable ===== */
  .bbdd-overlay{
    position:fixed; inset:0; z-index:9999;
    display:flex; align-items:center; justify-content:center;
    padding:clamp(6px,1.5vh,16px);
    background: rgba(8,12,28,.55);
    backdrop-filter: blur(16px) saturate(1.08);
    -webkit-backdrop-filter: blur(16px) saturate(1.08);
  }
  .bbdd-panel{
    width:min(1200px,100%);
    height:min(96dvh,100dvh);
    overflow:auto; /* el panel es el scroller */
    border-radius:14px; border:1px solid rgba(122,134,255,.18);
    background: linear-gradient(180deg, rgba(18,22,45,.86), rgba(12,16,35,.80));
    box-shadow: 0 24px 80px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.04);
  }

  /* ===== Barra 1: Header (siempre fija) ===== */
  .bbdd-header{
    position:sticky; top:0; z-index:40;
    display:flex; align-items:center; gap:12px;
    padding:12px 16px;
    background: linear-gradient(180deg, rgba(26,31,68,.95), rgba(18,22,45,.92));
    border-bottom:1px solid rgba(122,134,255,.20);
  }
  .bbdd-header .spacer{ flex:1; }

  /* ===== TIP (no sticky) ===== */
  .bbdd-tip{
    margin:12px 16px 8px; padding:12px 14px;
    border:1px solid rgba(122,134,255,.18);
    border-radius:12px;
    background: linear-gradient(180deg, rgba(28,34,74,.6), rgba(20,24,52,.6));
  }

  /* ===== Barra 2: Tools (sticky debajo del header) ===== */
  .bbdd-tools{
    position:sticky; top:var(--tools-top, 56px); z-index:35;
    display:grid; grid-template-columns:1fr 1fr 1fr; align-items:center;
    gap:12px; padding:8px 16px;
    background: linear-gradient(180deg, rgba(26,31,68,.94), rgba(20,24,52,.94));
    border-bottom:1px solid rgba(122,134,255,.18);
  }
  .bbdd-tools .left{ display:flex; align-items:center; gap:12px; }
  .bbdd-tools .center{ display:flex; justify-content:center; }
  .bbdd-tools .right{ display:flex; justify-content:flex-end; gap:10px; }

  /* ===== Barra 3: BARRA FIJA DE COLUMNAS (usamos ESTA, no thead) ===== */
  .bbdd-columns{
    display:grid !important;           /* aseguro que est√© visible */
    position:sticky; top:var(--columns-top, 100px); z-index:37;     /*///ACAAAAAAA*/
    grid-template-columns: var(--w-pilar) var(--w-rasgo) var(--w-stat) var(--w-task) var(--w-dificultad) var(--w-feedback) var(--w-eliminar);
    gap:var(--col-gap);
    margin:6px 4px 0;                  /* menos margen lateral = m√°s ancho √∫til */
    padding:8px 10px;
    border-radius:12px;
    background: linear-gradient(180deg, rgba(44,52,106,.95), rgba(26,31,68,.95));
    color:#dbe0ff; font-weight:600;
    border-bottom:1px solid rgba(122,134,255,.22);
  }
  .is-stuck .bbdd-columns{ padding:6px 8px; }  /* modo compacto cuando tools pega */

  /* ===== Contenedor de la tabla ===== */
  .bbdd-table-wrap{ margin:13px 1px 1px 1px; position:relative; }

  /* ===== Tabla + anchos por colgroup (alineado con barra fija) ===== */
  #bbdd-table{
    width:100%; border-collapse:separate; border-spacing:0;
    table-layout: fixed; /* clave */
  }
  #bbdd-table col.col-pilar      { width: var(--w-pilar); }
  #bbdd-table col.col-rasgo      { width: var(--w-rasgo); }
  #bbdd-table col.col-stat       { width: var(--w-stat); }
  #bbdd-table col.col-task       { width: var(--w-task); }
  #bbdd-table col.col-dificultad { width: var(--w-dificultad); }
  #bbdd-table col.col-feedback   { width: var(--w-feedback); }

  /* Ocultamos el THEAD real (accesibilidad s√≠, visual no) */
  #bbdd-table thead{
    position:absolute !important;
    width:1px; height:1px; overflow:hidden; clip:rect(0 0 0 0);
    white-space:nowrap;
  }

  /* Filas (compactas) */
  #bbdd-table tbody td{
    padding:6px 10px;
    border-bottom:1px solid rgba(122,134,255,.10);
    vertical-align:middle;
  }

  /* Spinner */
  #table-spinner{
    position:absolute; inset:0; display:true; z-index:80;
    align-items:center; justify-content:center; gap:12px;
    backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
    background: rgba(10,12,24,.45); color:#ecedff; font-weight:600;
  }
  .bbdd-table-wrap.table-loading #table-spinner{ display:flex; }

  /* Mobile */
  @media (max-width:768px){
    .bbdd-overlay{ align-items:stretch; padding:0; }
    .bbdd-panel{ width:100%; height:100dvh; border-radius:0; }
    .bbdd-tools{ top:var(--tools-top, 52px); }
  }
</style>
  
<script>
  (function(){
    // ‚Äî‚Äî Toggle gu√≠a (colapsada por defecto)
    const tip = document.getElementById('bbdd-tip');
    const btn = tip?.querySelector('.tip-toggle');
    function setTip(collapsed){
      tip.classList.toggle('collapsed', collapsed);
      if (btn) btn.setAttribute('aria-expanded', String(!collapsed));
      if (btn) btn.textContent = collapsed ? 'Mostrar gu√≠a' : 'Ocultar gu√≠a';
      calcToolsTop(); // por si cambia la altura
    }
    btn?.addEventListener('click', () => setTip(!tip.classList.contains('collapsed')));
    // inicia colapsada
    if (tip) setTip(true);

    // ‚Äî‚Äî Mantener el toolbar justo debajo del header
    function calcToolsTop(){
      const header = document.querySelector('.bbdd-header');
      const top = header ? header.getBoundingClientRect().height : 56;
      document.documentElement.style.setProperty('--tools-top', top + 'px');
    }
    window.addEventListener('load', calcToolsTop);
    window.addEventListener('resize', calcToolsTop);
    new ResizeObserver(calcToolsTop).observe(document.body);
  })();
</script>
  
<script>
  /* Sticky THEAD: compensa TIP, m√°rgenes del wrap y agrega un peque√±o clearance */
  (function () {
    const panel     = document.querySelector('.bbdd-panel');
    const header    = document.querySelector('.bbdd-header');
    const tools     = document.querySelector('.bbdd-tools');
    const tableWrap = document.querySelector('.bbdd-table-wrap');
  
    const CLEARANCE = 2;
    let S = { hH: 56, hT: 44, gap: 0, mTop: 0 };
  
    const px = v => (isNaN(parseFloat(v)) ? 0 : parseFloat(v));
  
    function measure() {
      const hH = header ? header.getBoundingClientRect().height : 56;
      const hT = tools  ? tools.getBoundingClientRect().height  : 44;
  
      const rectH = header.getBoundingClientRect();
      const rectT = tools .getBoundingClientRect();
      const gap   = Math.max(0, rectT.top - rectH.bottom);
  
      const cs    = tableWrap ? getComputedStyle(tableWrap) : null;
      const mTop  = cs ? px(cs.marginTop) : 0;
  
      S = { hH, hT, gap, mTop };
      document.documentElement.style.setProperty('--tools-top', hH + 'px');
    }
  
    function applyTheadTop(stuck) {
      const top = S.hH + S.hT + (stuck ? 0 : S.gap) - S.mTop + CLEARANCE;
      document.documentElement.style.setProperty('--thead-top', Math.max(0, top) + 'px');
    }
  
    // Sentinel para detectar cuando tools est√° pegado
    const sentinel = document.createElement('div');
    sentinel.style.height = '1px';
    tools.before(sentinel);
  
    const io = new IntersectionObserver(([e]) => {
      const stuck = !e.isIntersecting;
      panel.classList.toggle('is-stuck', stuck);
      applyTheadTop(stuck);
    }, { root: panel, threshold: 1 });
  
    function rerender() { measure(); applyTheadTop(panel.classList.contains('is-stuck')); }
  
    function init() {
      measure();
      io.observe(sentinel);
      applyTheadTop(false);
      if (document.fonts && document.fonts.ready) document.fonts.ready.then(rerender);
      requestAnimationFrame(rerender);
      setTimeout(rerender, 0);
  
      // NUEVO: si el scroll vuelve a 0, forzar estado ‚Äúno pegado‚Äù (respeta el gap)
      panel.addEventListener('scroll', () => {
        if (panel.scrollTop === 0) applyTheadTop(false);
      }, { passive: true });
    }
  
    new ResizeObserver(rerender).observe(document.body);
    window.addEventListener('load', init);
    window.addEventListener('resize', rerender);
    window.addEventListener('orientationchange', rerender);
  })();
</script>

</body>
</html>
