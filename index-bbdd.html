<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirmacion BBDD & Daily Quest</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/bbdd.css?v=6">
</head>
<body>
  <!-- Modal overlay: en desktop se usa como modal; en mobile ocupa toda la pantalla -->
  <div id="bbdd-overlay" class="bbdd-overlay hidden">
    <div class="bbdd-panel">
      <header class="bbdd-header">
        <button id="bbdd-back" class="btn ghost">‚Üê Volver</button>
        <h1>‚öôÔ∏è Conf BBDD & Daily Quest</h1>
        <div class="spacer"></div>
        <button id="bbdd-confirm" class="btn primary">Confirmar cambios ‚úì</button>
      </header>

      <section class="bbdd-tip gj-info collapsed" id="bbdd-tip">
        <b>üìå IMPORTANTE ‚Äì C√≥mo deben ser tus Tasks</b><br/>
        ‚úîÔ∏è Que puedas completarlas en un solo d√≠a.<br/>
        ‚úîÔ∏è Deben ser claras, espec√≠ficas y medibles.<br/>
        üö´ Evit√° frases vagas como ‚Äúhacer algo saludable‚Äù.<br/>
        üéØ Mejor: ‚ÄúPreparar una comida saludable‚Äù o ‚ÄúMeditar 10 minutos‚Äù.<br/>
        ‚ôªÔ∏è Ideal si pod√©s repetirlas cada semana.
        <div class="legend">
          <span>‚ú® Mejorar: pulir esta misma task</span>
          <span>üîÅ Modificar: proponer una distinta manteniendo Pilar/Rasgo/Stat/Dificultad</span>
        </div>
      </section>

      <section class="bbdd-tools">
        <div class="left">
          <button id="add-row" class="btn ghost">+ Fila</button>
          <span id="dirty-indicator" class="dot hidden">‚óè Cambios sin guardar</span>
        </div>
      
        <div class="center">
          <input id="search" class="input" placeholder="Filtrar‚Ä¶ (ej: 'ayuno', 'Mind')" />
        </div>
      
        <div class="right">
          <button id="bbdd-ai" class="btn ghost" title="Enviar a IA">‚ú® AI (Coming Soon)</button>
          <div id="ai-sparkle" class="ai-sparkle" style="display:none;"></div>
        </div>
      </section>

      <section id="table-wrap" class="bbdd-table-wrap">
        <!-- overlay/spinner centrado -->
        <div id="table-spinner" aria-live="polite" aria-busy="true">
          <span class="ring" aria-hidden="true"></span>
          <span class="txt">Cargando tus tareas‚Ä¶</span>
        </div>
      
        <table id="bbdd-table" class="bbdd-table" aria-label="Tabla BBDD">
          <thead>
            <tr>
              <th style="width:110px">Pilares</th>
              <th style="width:160px">Rasgo</th>
              <th style="width:160px">Stats</th>
              <th>Tasks</th>
              <th style="width:120px">Dificultad</th>
              <th style="width:120px">Feedback</th>
              <th style="width:60px"></th>
            </tr>
          </thead>
          <tbody id="bbdd-tbody"><!-- filas din√°micas --></tbody>
        </table>
      </section>

      <footer class="bbdd-footer">
        <small id="status-msg"></small>
        <div class="spacer"></div>
        <button id="close-modal" class="btn ghost">Cerrar</button>
      </footer>
    </div>
  </div>

  <script>
    // Configuraci√≥n de modo:
    // - Si se incluye en el dashboard, setear window.BBDD_MODE="modal" y llamar window.openBBDD(email)
    // - Si se quiere como p√°gina independiente, usar query ?email= y window.BBDD_MODE="page"
    window.BBDD_MODE = window.BBDD_MODE || (matchMedia("(max-width: 768px)").matches ? "page" : "modal");
  </script>
  <script src="js/bbdd.js"></script>
  <script>
  // Navegaci√≥n de vuelta al dashboard si vino con &back=
  (function () {
    const params = new URLSearchParams(location.search);
    const backURL = params.get('back'); // viene urlencodeado por el dashboard

    function goBack() {
      if (backURL) {
        location.href = decodeURIComponent(backURL);
      } else {
        // fallback razonable
        history.length > 1 ? history.back() : (location.href = 'dashboardv3.html');
      }
    }

    // Bot√≥n "Volver" del header (si existe)
    document.getElementById('btn-back')?.addEventListener('click', (e) => {
      e.preventDefault(); goBack();
    });

    // Bot√≥n "Cerrar" del footer (si existe)
    document.getElementById('close-modal')?.addEventListener('click', (e) => {
      e.preventDefault(); goBack();
    });
  })();
</script>
  
<style id="bbdd-hotfix">
  /* ‚Äî‚Äî‚Äî contenedor scrolleable ‚Äî‚Äî‚Äî */
  .bbdd-panel{
    width:min(1200px,100%);
    height:min(96dvh,100dvh);
    overflow:auto;                         /* el panel es el scroller */
    border-radius:14px; border:1px solid rgba(122,134,255,.18);
    background: linear-gradient(180deg, rgba(18,22,45,.86), rgba(12,16,35,.80));
    box-shadow: 0 24px 80px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.04);
  }
  .bbdd-header{
    position:sticky; top:0; z-index:30;   /* 1) header siempre fijo */
    display:flex; align-items:center; gap:12px;
    padding:12px 16px;
    background: linear-gradient(180deg, rgba(26,31,68,.95), rgba(18,22,45,.92));
    border-bottom:1px solid rgba(122,134,255,.20);
  }
  .bbdd-tip{                                /* IMPORTANTE: NO sticky */
    margin:12px 16px 8px; padding:12px 14px;
    border:1px solid rgba(122,134,255,.18);
    border-radius:12px;
    background: linear-gradient(180deg, rgba(28,34,74,.6), rgba(20,24,52,.6));
  }

  /* 2) tools sticky debajo del header cuando el tip ya sali√≥ */
  .bbdd-tools{
    position:sticky; top:var(--tools-top, 56px); z-index:25;
    display:grid; grid-template-columns:1fr 1fr 1fr; align-items:center;
    gap:12px; padding:8px 16px;
    background: linear-gradient(180deg, rgba(26,31,68,.94), rgba(20,24,52,.94));
    border-bottom:1px solid rgba(122,134,255,.18);
    transition: padding .15s ease, box-shadow .15s ease;
  }
  /* 3) thead sticky debajo de tools */
  .bbdd-table-wrap{ margin:12px 16px 16px; }
  #bbdd-table{ width:100%; border-collapse:separate; border-spacing:0; }
  #bbdd-table thead th{
    position:sticky; top:var(--thead-top, 100px); z-index:20;
    padding:8px 10px;
    background: linear-gradient(180deg, rgba(44,52,106,.95), rgba(26,31,68,.95));
    color:#dbe0ff; border-bottom:1px solid rgba(122,134,255,.22);
    text-align:left; white-space:nowrap; font-weight:600;
    transition: padding .15s ease;
  }
  #bbdd-table tbody td{ padding:6px 10px; border-bottom:1px solid rgba(122,134,255,.10); }

  /* ‚Äî‚Äî modo compacto cuando tools est√° pegado (m√°s filas visibles) ‚Äî‚Äî */
  .is-stuck .bbdd-tools{ padding:6px 12px; box-shadow: 0 6px 12px rgba(0,0,0,.25); }
  .is-stuck #bbdd-table thead th{ padding:6px 8px; }

  /* overlay (fuera de foco) */
  .bbdd-overlay{
    position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center;
    padding:clamp(8px,2vh,24px);
    background: rgba(8,12,28,.55);
    backdrop-filter: blur(16px) saturate(1.08);
    -webkit-backdrop-filter: blur(16px) saturate(1.08);
  }
  @media (max-width:768px){
    .bbdd-overlay{ align-items:stretch; padding:0; }
    .bbdd-panel{ width:100%; height:100dvh; border-radius:0; }
    .bbdd-tools{ top:var(--tools-top, 52px); }
  }
</style>
<script>
  (function(){
    const btn = document.getElementById('bbdd-back');
    if(!btn) return;
    btn.addEventListener('click', function(e){
      e.preventDefault();
      const u = new URL(location.href);
      const email = (u.searchParams.get('email') || localStorage.getItem('gj_email') || '').trim().toLowerCase();
      const cameFromDash = document.referrer && /dashboard/i.test(document.referrer);
      if (cameFromDash && history.length > 1) { history.back(); return; }
      const dash = new URL('dashboardv3.html', location.origin);
      if (email) dash.searchParams.set('email', email);
      location.href = dash.toString();
    });
  })();
</script>
  
<script>
  (function(){
    // ‚Äî‚Äî Toggle gu√≠a (colapsada por defecto)
    const tip = document.getElementById('bbdd-tip');
    const btn = tip?.querySelector('.tip-toggle');
    function setTip(collapsed){
      tip.classList.toggle('collapsed', collapsed);
      if (btn) btn.setAttribute('aria-expanded', String(!collapsed));
      if (btn) btn.textContent = collapsed ? 'Mostrar gu√≠a' : 'Ocultar gu√≠a';
      calcToolsTop(); // por si cambia la altura
    }
    btn?.addEventListener('click', () => setTip(!tip.classList.contains('collapsed')));
    // inicia colapsada
    if (tip) setTip(true);

    // ‚Äî‚Äî Mantener el toolbar justo debajo del header
    function calcToolsTop(){
      const header = document.querySelector('.bbdd-header');
      const top = header ? header.getBoundingClientRect().height : 56;
      document.documentElement.style.setProperty('--tools-top', top + 'px');
    }
    window.addEventListener('load', calcToolsTop);
    window.addEventListener('resize', calcToolsTop);
    new ResizeObserver(calcToolsTop).observe(document.body);
  })();
</script>
  
<script>
  /* Sticky correcto del thead: compensa el alto del TIP cuando a√∫n est√° visible */
  (function(){
    const panel  = document.querySelector('.bbdd-panel');
    const header = document.querySelector('.bbdd-header');
    const tools  = document.querySelector('.bbdd-tools');
  
    let S = { hH:56, hT:44, gap:0 };
  
    function measure() {
      const hH = header ? header.getBoundingClientRect().height : 56;
      const hT = tools  ? tools.getBoundingClientRect().height  : 44;
  
      // Distancia entre el borde inferior del header y el borde superior de tools.
      // Mientras el TIP est√© visible, este "gap" es > 0; cuando tools se pega, gap ‚âà 0.
      const rectH = header.getBoundingClientRect();
      const rectT = tools .getBoundingClientRect();
      const gap   = Math.max(0, rectT.top - rectH.bottom);
  
      S = { hH, hT, gap };
  
      // Tools se pega justo debajo del header
      document.documentElement.style.setProperty('--tools-top', hH + 'px');
    }
  
    function applyTheadTop(stuck) {
      // Si NO est√° pegado (TIP visible): hH + gap + hT
      // Si est√° pegado: hH + hT
      const top = S.hH + S.hT + (stuck ? 0 : S.gap);
      document.documentElement.style.setProperty('--thead-top', top + 'px');
    }
  
    // Sentinel para saber cu√°ndo tools queda "pegado"
    const sentinel = document.createElement('div');
    sentinel.style.height = '1px';
    tools.before(sentinel);
  
    const io = new IntersectionObserver(([e]) => {
      const stuck = !e.isIntersecting;
      panel.classList.toggle('is-stuck', stuck);
      applyTheadTop(stuck);
    }, { root: panel, threshold: 1 });
  
    function init(){
      measure();
      io.observe(sentinel);
      applyTheadTop(false); // Estado inicial: arriba del todo (TIP visible)
    }
  
    // Recalcular en cambios de layout
    const rerender = () => { measure(); applyTheadTop(panel.classList.contains('is-stuck')); };
    new ResizeObserver(rerender).observe(document.body);
    window.addEventListener('load', init);
    window.addEventListener('resize', rerender);
  })();
</script>

</body>
</html>
