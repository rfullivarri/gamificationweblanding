<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirmacion BBDD & Daily Quest</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/bbdd.css?v=6">
</head>
<body>
  <!-- Modal overlay: en desktop se usa como modal; en mobile ocupa toda la pantalla -->
  <div id="bbdd-overlay" class="bbdd-overlay hidden">
    <div class="bbdd-panel">
      <header class="bbdd-header">
        <button id="bbdd-back" class="btn ghost">← Volver</button>
        <h1>⚙️ Conf BBDD & Daily Quest</h1>
        <div class="spacer"></div>
        <button id="bbdd-confirm" class="btn primary">Confirmar cambios ✓</button>
      </header>

      <section class="bbdd-tip gj-info">
        <b>📌 IMPORTANTE – Cómo deben ser tus Tasks</b><br/>
        ✔️ Que puedas completarlas en un solo día.<br/>
        ✔️ Deben ser claras, específicas y medibles.<br/>
        🚫 Evitá frases vagas como “hacer algo saludable”.<br/>
        🎯 Mejor: “Preparar una comida saludable” o “Meditar 10 minutos”.<br/>
        ♻️ Ideal si podés repetirlas cada semana.
        <div class="legend">
          <span>✨ Mejorar: pulir esta misma task</span>
          <span>🔁 Modificar: proponer una distinta manteniendo Pilar/Rasgo/Stat/Dificultad</span>
        </div>
      </section>

      <section class="bbdd-tools">
        <div class="left">
          <button id="add-row" class="btn ghost">+ Fila</button>
          <span id="dirty-indicator" class="dot hidden">● Cambios sin guardar</span>
        </div>
      
        <div class="center">
          <input id="search" class="input" placeholder="Filtrar… (ej: 'ayuno', 'Mind')" />
        </div>
      
        <div class="right">
          <button id="bbdd-ai" class="btn ghost" title="Enviar a IA">✨ AI (Coming Soon)</button>
          <div id="ai-sparkle" class="ai-sparkle" style="display:none;">
        </div>
      </section>

      <section id="table-wrap" class="bbdd-table-wrap">
        <!-- overlay/spinner centrado -->
        <div id="table-spinner" aria-live="polite" aria-busy="true">
          <span class="ring" aria-hidden="true"></span>
          <span class="txt">Cargando tus tareas…</span>
        </div>
      
        <table id="bbdd-table" class="bbdd-table" aria-label="Tabla BBDD">
          <thead>
            <tr>
              <th style="width:110px">Pilares</th>
              <th style="width:160px">Rasgo</th>
              <th style="width:160px">Stats</th>
              <th>Tasks</th>
              <th style="width:120px">Dificultad</th>
              <th style="width:120px">Feedback</th>
              <th style="width:60px"></th>
            </tr>
          </thead>
          <tbody id="bbdd-tbody"><!-- filas dinámicas --></tbody>
        </table>
      </section>

      <footer class="bbdd-footer">
        <small id="status-msg"></small>
        <div class="spacer"></div>
        <button id="close-modal" class="btn ghost">Cerrar</button>
      </footer>
    </div>
  </div>

  <script>
    // Configuración de modo:
    // - Si se incluye en el dashboard, setear window.BBDD_MODE="modal" y llamar window.openBBDD(email)
    // - Si se quiere como página independiente, usar query ?email= y window.BBDD_MODE="page"
    window.BBDD_MODE = window.BBDD_MODE || (matchMedia("(max-width: 768px)").matches ? "page" : "modal");
  </script>
  <script src="js/bbdd.js"></script>
  <script>
  // Navegación de vuelta al dashboard si vino con &back=
  (function () {
    const params = new URLSearchParams(location.search);
    const backURL = params.get('back'); // viene urlencodeado por el dashboard

    function goBack() {
      if (backURL) {
        location.href = decodeURIComponent(backURL);
      } else {
        // fallback razonable
        history.length > 1 ? history.back() : (location.href = 'dashboardv3.html');
      }
    }

    // Botón "Volver" del header (si existe)
    document.getElementById('btn-back')?.addEventListener('click', (e) => {
      e.preventDefault(); goBack();
    });

    // Botón "Cerrar" del footer (si existe)
    document.getElementById('close-modal')?.addEventListener('click', (e) => {
      e.preventDefault(); goBack();
    });
  })();
</script>

<style id="bbdd-hotfix">
  /* ====== HOTFIX ====== */
  .bbdd-overlay{
    position:fixed; inset:0; z-index:9999;
    display:flex; align-items:center; justify-content:center; padding:24px;
    background: rgba(8,12,28,.55);
    backdrop-filter: blur(16px) saturate(1.08);
    -webkit-backdrop-filter: blur(16px) saturate(1.08);
  }
  .bbdd-panel{
    width:min(1200px,100%); height:min(90vh,100%);
    display:flex; flex-direction:column; overflow:hidden;   /* <- clave */
    border-radius:14px; border:1px solid rgba(122,134,255,.18);
    background: linear-gradient(180deg, rgba(18,22,45,.86), rgba(12,16,35,.80));
    box-shadow: 0 24px 80px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.04);
  }
  /* Área de tabla que scrollea (desktop) */
  #table-wrap{
    position:relative; flex:1 1 auto; min-height:360px;
    overflow:auto; margin:0 16px 16px; border-radius:14px;
  }
  /* Header sticky */
  #bbdd-table{ width:100%; border-collapse:separate; border-spacing:0; }
  #bbdd-table thead th{
    position:sticky; top:0; z-index:3;
    padding:10px 12px;
    background: linear-gradient(180deg, rgba(44,52,106,.85), rgba(26,31,68,.88));
    color:#dbe0ff; border-bottom:1px solid rgba(122,134,255,.22);
  }
  /* Spinner centrado */
  #table-spinner{
    position:absolute; inset:0; display:none; z-index:4;
    display:flex; align-items:center; justify-content:center; gap:12px;
    backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
    background: rgba(10,12,24,.45); color:#ecedff; font-weight:600;
  }
  #table-wrap.table-loading #table-spinner{ display:flex; }
  #table-wrap.table-loading #bbdd-table{ filter:blur(1px); opacity:.6; pointer-events:none; }
  /* Scrollbar oscuro */
  #table-wrap::-webkit-scrollbar{ width:10px; height:10px; }
  #table-wrap::-webkit-scrollbar-thumb{
    background: rgba(122,134,255,.28); border-radius:10px; border:2px solid transparent; background-clip: padding-box;
  }
  #table-wrap::-webkit-scrollbar-track{ background: transparent; }
  
  /* ===== Mobile: scrollea el panel completo ===== */
  @media (max-width:768px){
    .bbdd-overlay{ align-items:stretch; padding:0; }
    .bbdd-panel{
      height:100vh; max-height:100vh; overflow:auto; border-radius:0;
      padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px)); /* evita corte abajo */
    }
    #table-wrap{
      flex:0 0 auto; overflow:visible; margin:0 12px 12px; border-radius:14px;
    }
    #bbdd-table thead th{ position:sticky; top:0; z-index:5; }
  }
</style>

<script>
  (function(){
    const btn = document.getElementById('bbdd-back');
    if(!btn) return;
    btn.addEventListener('click', function(e){
      e.preventDefault();
      const u = new URL(location.href);
      const email = (u.searchParams.get('email') || localStorage.getItem('gj_email') || '').trim().toLowerCase();
      const cameFromDash = document.referrer && /dashboard/i.test(document.referrer);
      if (cameFromDash && history.length > 1) { history.back(); return; }
      const dash = new URL('dashboardv3.html', location.origin);
      if (email) dash.searchParams.set('email', email);
      location.href = dash.toString();
    });
  })();
</script>
</body>
</html>
