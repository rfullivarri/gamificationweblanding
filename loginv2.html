<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Login — Gamification Journey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#7d3cff">
  <style>
    :root{
      --bg:#0b0f19; --card:#121829; --ink:#e8ecf1; --muted:#9aa3b2;
      --accent:#7d3cff; --accent-2:#5c28c2; --line:rgba(255,255,255,.14);
      --overlay:rgba(8,10,16,.55);
      --chip-glass-from: rgba(255,255,255,.06);
      --chip-glass-to:   rgba(255,255,255,.02);
      --chip-radius: 14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family: system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 800px at 20% -10%, #1a2340 0%, rgba(26,35,64,0) 60%),
        radial-gradient(1000px 700px at 120%   0%, #321a63 0%, rgba(50,26,99,0) 60%),
        var(--bg);
      color:var(--ink);
      display:flex;flex-direction:column;
    }
  
    /* NAVBAR */
    .nav{
      width:100%; background:rgba(18,24,41,.6); border-bottom:1px solid var(--line);
      backdrop-filter: blur(6px);
      display:flex; align-items:center; justify-content:center; padding:12px 16px;
      position:sticky; top:0; z-index:40;
    }
    .nav a{color:#fff; text-decoration:none; font-weight:900}
    .nav a:hover{text-decoration:underline}
  
    /* CONTENIDO */
    .wrap{flex:1; display:grid; place-items:center; padding:24px}
    .card{
      width:100%; max-width:520px;
      background:linear-gradient(180deg, var(--chip-glass-from), var(--chip-glass-to));
      border:1px solid var(--line); border-radius:18px; padding:24px; backdrop-filter: blur(8px);
      box-shadow:0 20px 60px rgba(0,0,0,.35);
    }
    h1{margin:0 0 8px; font-size:26px; font-weight:900; text-align:center}
    .sub{margin:0 0 18px; color:var(--muted); text-align:center; line-height:1.55}
    .field{margin:14px 0 6px}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input[type="email"]{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--line);
      background:#0f1526; color:#e8ecf1; outline:none; text-align:center;
    }
    input::placeholder{color:#7f8aa3}
    .actions{display:flex; gap:10px; justify-content:center; margin-top:14px; flex-wrap:wrap}
    .btn{
      appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:800;
      background:var(--accent); color:#fff; cursor:pointer; transition:.2s background,.05s transform;
    }
    .btn:hover{background:var(--accent-2)} .btn:active{transform:translateY(1px)}
    .btn.secondary{
      background:transparent; border:1px solid var(--line); color:#e8ecf1
    }
    .status{margin-top:10px; color:var(--muted); font-size:13px; text-align:center; min-height:20px}
  
    /* SPINNER */
    .spinner{
      width:18px;height:18px;border-radius:50%;
      border:3px solid rgba(255,255,255,.2); border-top-color:#fff;
      animation:spin .9s linear infinite; display:inline-block; vertical-align:middle; margin-left:8px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  
    /* MODAL (base) */
    .modal{
      position:fixed; inset:0; display:none; place-items:center; padding:20px;
      background:var(--overlay); z-index:100; backdrop-filter: blur(2px);
    }
    .modal.visible{display:grid}
    .modal-card{
      width:100%; max-width:760px;
      background:linear-gradient(180deg, var(--chip-glass-from), var(--chip-glass-to));
      border:1px solid var(--line); border-radius:18px; padding:20px 22px 18px; position:relative;
      box-shadow:0 30px 80px rgba(0,0,0,.5); backdrop-filter: blur(10px);
    }
    .close{
      position:absolute; top:12px; right:12px; width:38px; height:38px; border-radius:12px;
      display:grid; place-items:center; cursor:pointer; border:1px solid var(--line);
      color:#cfd6ec; background:rgba(255,255,255,.02);
    }
    .close:hover{border-color:#fff; color:#fff}
    .modal-title{margin:0 0 6px; font-weight:900; font-size:22px}
    .modal-body{color:var(--muted); font-size:14px; line-height:1.6}
    .pill{
      display:inline-block; font-size:12px; padding:4px 10px; border-radius:999px;
      border:1px solid var(--line); color:#cfd6ec; background:linear-gradient(180deg, var(--chip-glass-from), var(--chip-glass-to));
    }
    .modal-actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-top:14px}
  
    /* TIP con borde lila (arriba, más visible) */
    .callout{
      position:relative; padding:12px 12px 12px 18px; margin:12px 0 12px;
      border:1px dashed var(--line); border-radius:14px; color:#cdd6f4;
      background:rgba(125,60,255,.08);
    }
    .callout::before{
      content:""; position:absolute; left:10px; top:10px; bottom:10px; width:4px; border-radius:4px;
      background:linear-gradient(180deg, #7d3cff 0%, rgba(125,60,255,.25) 100%);
    }
  
    /* glow sutil por paso */
    .is-blue  { box-shadow: inset 0 0 0 2px rgba(92,162,255,.18),  0 10px 28px rgba(92,162,255,.08); }
    .is-green { box-shadow: inset 0 0 0 2px rgba(105,219,124,.20), 0 10px 28px rgba(105,219,124,.09); }
    .is-amber { box-shadow: inset 0 0 0 2px rgba(255,190,92,.22),  0 10px 28px rgba(255,190,92,.10); }
  
    /* —— “Mientras tanto” —— */
    .section-subtitle{ text-align:center; margin:10px 0 6px; color:#cfd6ec; font-weight:900 }
    .action-chips{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin:8px 0 2px }
    .pill-btn{
      border:1px solid var(--line);
      background:linear-gradient(180deg, var(--chip-glass-from), var(--chip-glass-to));
      color:#e8ecf1; padding:10px 14px; border-radius:999px; font-weight:800;
    }
    /* violeta para “Instalar app” */
    #installBtn{ background:#7d3cff; border-color:#7d3cff; color:#fff; }
    #installBtn:hover{ background:#5c28c2 }
    /* “Copiar link” mismo tamaño pero ghost */
    #copyLinkBtn{ background:transparent; }
    .chip-note{
      display:block; text-align:center; font-size:12px; color:#aab2c5; margin-top:2px;
    }
  
    /* Botones del footer del modal con look de chip */
    .modal-actions .btn{
      background:linear-gradient(180deg, var(--chip-glass-from), var(--chip-glass-to));
      color:#e8ecf1; border:1px solid var(--line); font-weight:900;
    }
    .modal-actions .btn:hover{ background:rgba(255,255,255,.08) }
  
    /* Ocultos por defecto para que JS los active contextualmente */
    #installBtn{ display:none; }
    .step.is-blue  { box-shadow: inset 0 0 0 2px rgba(92,162,255,.18),  0 10px 28px rgba(92,162,255,.08); }
    .step.is-green { box-shadow: inset 0 0 0 2px rgba(105,219,124,.20), 0 10px 28px rgba(105,219,124,.09); }
    .step.is-amber { box-shadow: inset 0 0 0 2px rgba(255,190,92,.22),  0 10px 28px rgba(255,190,92,.10); }
    .chip-note { font-size:11px; color:#aab2c5; text-align:center; margin-top:4px; }

    
    /* ===== FIXES ===== */
    /* Fondo del overlay con blur (se mantiene) */
    .modal{
      background: rgba(8,10,16,.55);
      backdrop-filter: blur(4px);
    }
    
    /* Tarjeta del modal: opaca (no se ve atrás), sin blur interno */
    .modal-card{
    width:100%; max-width:760px;
    /* fondo sólido + leve glass, ya NO se transparenta el contenido de atrás */
    background: rgba(18,24,41,.94);            /* <- sólido */
    border:1px solid var(--line); 
    border-radius:18px; 
    padding:20px 22px 18px; 
    position:relative;
    box-shadow:0 30px 80px rgba(0,0,0,.55);
    backdrop-filter: blur(10px);               /* glass suave encima del sólido */
  }
      
    /* === Próximos pasos → cards iguales (rectangulares, glassy y simples) === */
    .steps-title{
      text-align:center;
      margin:8px 0 12px;
      font-weight:900;
      color:#cfd6ec;
    }
    
    .steps-row{
      display:grid;
      gap:14px;
      margin:10px 0 14px;
      grid-template-columns:1fr;                 /* mobile */
    }
    @media (min-width:720px){
      .steps-row{ grid-template-columns:repeat(3,1fr); } /* 3 en línea en desktop */
    }
    
    /* Card de paso (NO botón) */
    .step{
      display:flex; align-items:center; justify-content:center;
      height:60px;                               /* alto parejo, más compacto */
      padding:0 16px;                            /* menos panza */
      border-radius:12px;                        /* curvita corta (no pastilla) */
      cursor:default;                            /* no parece botón */
      text-align:center; font-weight:900; letter-spacing:.2px; color:#e8ecf1;
    
      /* glassy sutil y translúcido */
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      backdrop-filter:blur(4px);
    
      /* borde “blanco” suave como Copiar link */
      border:1px solid rgba(255,255,255,.20);
    
      /* bisel MUY leve para evitar efecto plástico */
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
      transition:.15s ease;
    }
    .step:hover{
      transform:translateY(-1px);
      border-color:rgba(255,255,255,.30);
    }

    
    /* Chips de acción (instalar / copiar) */
    .pill-btn{
      border:1px solid rgba(255,255,255,.22);
      background:transparent;                            /* ghost por defecto */
      color:#e8ecf1; padding:10px 14px; border-radius:999px; font-weight:800;
    }
    
    /* Violeta para destacar (Instalar app y Crear cuenta) */
    .pill-btn.accent{ background:#7d3cff; border-color:#7d3cff; color:#fff; }
    .pill-btn.accent:hover{ background:#5c28c2; }
    
    /* Copiar link: ghost */
    #copyLinkBtn{ background:transparent; }
    
    /* Ocultar botón Instalar por defecto: lo muestra JS (iOS/Android) */
    #installBtn{ display:none; }
    
    /* Ayuda iOS: oculta por defecto; solo al tocar Instalar en iPhone */
    #installHelp{
      display:none;
      margin:8px 0 0; padding:10px 12px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius:12px; color:#cfd6ec;
    }
    
    /* Nota chiquita debajo de “Copiar link” */
    .chip-note{ font-size:12px; color:#aab2c5; text-align:center; margin-top:4px; }
    /* Botón violeta de la app para cualquier chip con .accent */
    .pill-btn.accent{ background:#7d3cff; border-color:#7d3cff; color:#fff; }
    .pill-btn.accent:hover{ background:#5c28c2; }
    
    /* Copiar link: ghost con borde blanco (ya lo tenés, lo dejo explícito) */
#copyLinkBtn{ background:transparent; border:1px solid rgba(255,255,255,.22); color:#e8ecf1; }
  </style>
</head>
<body>
  <!-- NAV -->
  <div class="nav">
    <a href="indexv2.html">Gamification Journey</a>
  </div>

  <!-- CONTENIDO -->
  <div class="wrap">
    <div class="card">
      <h1>Entrar al Dashboard</h1>
      <p class="sub">
        Ingresá tu correo. Si tu base ya está lista te llevo directo al
        <strong>Dashboard</strong>. Si no, te muestro los pasos y espero con vos 👀.
      </p>

      <form id="loginForm" novalidate>
        <div class="field">
          <label for="email">Correo</label>
          <input id="email" name="email" type="email" placeholder="tu@email.com" required />
        </div>

        <div class="actions">
          <button id="goBtn" class="btn" type="submit">Continuar</button>
          <a class="btn secondary" href="indexv2.html">Volver al inicio</a>
        </div>

        <div id="status" class="status"></div>
      </form>
    </div>
  </div>

  <!-- MODAL AWAIT -->
  <section id="awaitModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="awaitTitle">
    <div class="modal-card">
      <button id="closeModal" class="close" title="Volver al login">✕</button>
  
      <h2 id="awaitTitle" class="modal-title">🕒 Preparando tu mundo…</h2>
  
      <div class="modal-body">
        <p>
          Estamos creando tu espacio. En unos minutos te llegará un
          <span class="pill">pergamino digital</span> (un mail) para confirmar tu usuario.
        </p>
  
        <!-- TIP arriba -->
        <div class="callout">
          Tip: revisá también <strong>Spam/Promociones</strong> si el mail no aparece enseguida.
        </div>
  
        <!-- Próximos pasos -->
        <h3 class="steps-title">Próximos pasos</h3>
        <div class="steps-row">
          <span class="step is-blue">Login</span>
          <span class="step is-green">Confirmar BBDD</span>
          <span class="step is-amber">Programar Daily&nbsp;Quest</span>
        </div>
  
        <!-- Mientras tanto -->
        <h4 class="section-subtitle">Mientras tanto</h4>
        <div class="action-chips">
          <button id="installBtn"  type="button" class="pill-btn accent">Instalar app</button>
          <button id="copyLinkBtn" type="button" class="pill-btn">Copiar link</button>
        </div>
        <div class="chip-note">Usá “Copiar link” para abrirlo en tu móvil.</div>
  
        <!-- Ayuda iOS (se muestra al tocar Instalar app en iPhone) -->
        <div id="installHelp">
          <strong>iPhone (Safari)</strong>
          <ol>
            <li>Tocá <em>Compartir</em> (icono ↑).</li>
            <li>Elegí <em>Agregar a inicio</em>.</li>
            <li>Confirmá el nombre y guardá.</li>
          </ol>
        </div>
      </div>
  
      <div class="modal-actions">
        <a id="signupBtn" class="pill-btn accent"   href="signupv2.html">Crear cuenta</a>
        <a                 class="pill-btn"         href="indexv2.html">Volver al inicio</a>
      </div>
    </div>
  </section>

  <!-- MODAL NOT-FOUND -->
  <section id="notFoundModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="nfTitle">
    <div class="modal-card">
      <button id="closeNF" class="close" title="Cerrar" aria-label="Cerrar">✕</button>
      <h2 id="nfTitle" class="modal-title">❌ No encontramos tu cuenta</h2>

      <div class="modal-body">
        <p>No hay un usuario registrado con ese correo. Creá tu cuenta en un minuto y empezá tu Journey.</p>
      </div>

      <div class="modal-actions">
        <a id="signupNF" class="btn" href="signupv2.html">Crear cuenta</a>
        <button id="backNF" class="btn secondary" type="button">Volver</button>
      </div>
    </div>
  </section>

  <script>
    /* ================== CONFIG ================== */
    const CHECK_ENDPOINT = "https://script.google.com/macros/s/AKfycbzOvVEFFtNQfFE28AK5Tgi7kwdzn4if5tbLHofmlyAQ3fiVLdQgwXah2TcqTZDLEzua/exec";
    const POLL_MS = 10000;
    const DASHBOARD = "dashboardv3.html";
  
    /* ================== UTILS ================== */
    function qs(n){ const p=new URLSearchParams(location.search); return (p.get(n)||"").trim(); }
    function setStatus(msg, spinning=false){
      const $status = document.getElementById('status');
      if (!$status) return;
      $status.innerHTML = spinning ? `${msg} <span class="spinner"></span>` : msg;
    }
    function showModal(id){ const m=document.getElementById(id); if(!m) return; m.classList.add('visible'); m.setAttribute('aria-hidden','false'); }
    function hideModal(id){ const m=document.getElementById(id); if(!m) return; m.classList.remove('visible'); m.setAttribute('aria-hidden','true'); }
    function disable(el,v){ if(!el) return; el.disabled = !!v; el.style.opacity = v ? 0.7 : 1; }
  
    const UA = navigator.userAgent || '';
    const isIOS = /iPhone|iPad|iPod/i.test(UA);
    const isAndroid = /Android/i.test(UA);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
  
    /* ================== CHECKER ================== */
    async function checkStatus(email){
      const res = await fetch(`${CHECK_ENDPOINT}?email=${encodeURIComponent(email)}`, {cache:'no-store'});
      if (res.status === 404) return { ok:false, notFound:true };
      let data = {};
      try { data = await res.json(); } catch { data = {}; }
      if (data && data.notFound) return { ok:false, notFound:true };
      return data;
    }
    function isReady(d){ return d && d.ok && (d.has_url || d.ready); }
    function isNotFound(d){
      if (!d) return false;
      if (d.notFound === true) return true;
      const m = (d.message||d.error||d.reason||'').toString().toLowerCase();
      return /no existe|not found|no encontrado/.test(m);
    }
  
    /* ================== LOGIN FLOW ================== */
    let pollTimer=null, lastEmail="";
    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const $goBtn = document.getElementById('goBtn');
      const email = (document.getElementById('email').value||"").trim().toLowerCase();
      if(!email || !email.includes('@')){ setStatus('Ingresá un correo válido.'); return; }
      lastEmail=email;
  
      if(!CHECK_ENDPOINT || CHECK_ENDPOINT.startsWith("PON_AQUI")) {
        showModal('awaitModal'); return;
      }
  
      disable($goBtn,true); setStatus('Chequeando estado…', true);
      try{
        const data = await checkStatus(email);
  
        // Usuario no existe
        if (isNotFound(data)){
          setStatus('Ese correo no está registrado.');
          hideModal('awaitModal');
          showModal('notFoundModal');
          const $f = document.getElementById('signupNF'); if ($f) $f.focus();
          return;
        }
  
        // Listo → entrar
        if (isReady(data)){
          setStatus('Listo, entrando…', true);
          window.location.href = `${DASHBOARD}?email=${encodeURIComponent(email)}`;
          return;
        }
  
        // En proceso → esperar
        setStatus('Tu base está en proceso. Te avisamos acá.');
        showModal('awaitModal'); startPolling();
  
      }catch(_){
        setStatus('Está lento. Te muestro los pasos y seguimos chequeando…');
        showModal('awaitModal'); startPolling();
      }finally{
        disable($goBtn,false);
      }
    });
  
    function startPolling(){
      stopPolling();
      pollTimer=setInterval(async ()=>{
        try{
          const data = await checkStatus(lastEmail);
          if (isNotFound(data)){
            stopPolling(); hideModal('awaitModal');
            setStatus('Ese correo no está registrado.');
            showModal('notFoundModal');
            return;
          }
          if (isReady(data)){
            stopPolling(); hideModal('awaitModal');
            window.location.href = `${DASHBOARD}?email=${encodeURIComponent(lastEmail)}`;
          }
        }catch(_){}
      }, POLL_MS);
    }
    function stopPolling(){ if(pollTimer){ clearInterval(pollTimer); pollTimer=null; } }
  
    // Cierres / acciones modales
    document.getElementById('closeModal')
      .addEventListener('click', ()=>{
        stopPolling();
        hideModal('awaitModal');
        setStatus('Listo para intentar de nuevo.');
      });
    
    // El botón "Reintentar" ya no se usa; si existe en alguna versión, lo manejamos igual.
    const retry = document.getElementById('retryBtn'); // <- ojo: 'retryBtn' con B mayúscula
    if (retry){
      retry.addEventListener('click', async ()=>{
        if(!lastEmail) return;
        const t = retry.textContent;
        retry.innerHTML = `Reintentando <span class="spinner"></span>`;
        retry.disabled = true;
        try{
          const data = await checkStatus(lastEmail);
          if (isNotFound(data)){
            stopPolling(); hideModal('awaitModal');
            setStatus('Ese correo no está registrado.');
            showModal('notFoundModal');
            return;
          }
          if (isReady(data)){
            stopPolling(); hideModal('awaitModal');
            window.location.href = `${DASHBOARD}?email=${encodeURIComponent(lastEmail)}`;
          }
        }catch(_){/* noop */}
        finally{
          retry.textContent = t;
          retry.disabled = false;
        }
      });
    }
  
    document.getElementById('closeNF')?.addEventListener('click', ()=> hideModal('notFoundModal'));
    document.getElementById('backNF')?.addEventListener('click', ()=> hideModal('notFoundModal'));
  
    // Modo “forzar popup” desde el mail (await=1)
    (function boot(){
      // En iOS mostramos de entrada el botón Instalar (abre ayuda)
      const $installBtn = document.getElementById('installBtn');
      if (isIOS && $installBtn) $installBtn.style.display = 'inline-block';
  
      const force = qs('await');
      const pre = qs('email');
      if (pre) document.getElementById('email').value = pre;
      if (force === '1') {
        showModal('awaitModal');
        if (pre && CHECK_ENDPOINT && !CHECK_ENDPOINT.startsWith("PON_AQUI")){
          lastEmail = pre.toLowerCase();
          startPolling();
        }
      }
    })();
  
    // Enter directo
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && document.activeElement === document.getElementById('email')){
        e.preventDefault(); document.getElementById('goBtn').click();
      }
    });
  
    /* ================== PWA: Instalar / Copy link ================== */
    const $installBtn = document.getElementById('installBtn');
    const $copyLinkBtn = document.getElementById('copyLinkBtn');
    const $installHelp = document.getElementById('installHelp');
    let deferredPrompt = null;
  
    // Android/Chromium: habilita el botón cuando hay prompt
    window.addEventListener('beforeinstallprompt', (e) => {
      if (isStandalone) return;         // si ya está instalada, no sugerimos
      e.preventDefault();
      deferredPrompt = e;
      if ($installBtn) $installBtn.style.display = 'inline-block';
    });
  
    // Click en “Instalar app”
    $installBtn?.addEventListener('click', async ()=>{
      if (deferredPrompt) {
        // Android/desktop compatibles
        deferredPrompt.prompt();
        try { await deferredPrompt.userChoice; } catch {}
        deferredPrompt = null;
        return;
      }
      if (isIOS) {
        // iOS → mostrar ayuda compacta en el mismo modal
        if ($installHelp) $installHelp.style.display = 'block';
        return;
      }
      // Fallback genérico
      alert('Si tu navegador lo permite, usá “Instalar app / Agregar a la pantalla de inicio”.');
    });
  
    // Construye un link portable con await=1 (+ email si está cargado)
    function buildPortalUrlForMobile(){
      const base = `${location.origin}${location.pathname}`;
      const email = (document.getElementById('email').value||'').trim().toLowerCase();
      const params = new URLSearchParams({ await:'1' });
      if (email) params.set('email', email);
      return `${base}?${params.toString()}`;
    }
  
    // Copiar link del portal
    $copyLinkBtn?.addEventListener('click', async ()=>{
      const url = buildPortalUrlForMobile();
      try{
        await navigator.clipboard.writeText(url);
        const old = $copyLinkBtn.textContent;
        $copyLinkBtn.textContent = 'Copiado ✓';
        setTimeout(()=> $copyLinkBtn.textContent = old, 1400);
      }catch{
        prompt('Copiá este link:', url);
      }
    });
  </script>
  
  <!-- SW -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js', { scope: './' })
          .then(r => console.log('[SW] registrado', r.scope))
          .catch(e => console.error('[SW] error', e));
      });
    }
  </script>
</body>
</html>
