<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Login ‚Äî Gamification Journey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f19; --card:#121829; --ink:#e8ecf1; --muted:#9aa3b2;
      --accent:#7d3cff; --accent-2:#5c28c2; --line:rgba(255,255,255,.14);
      --overlay:rgba(0,0,0,.7);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family: system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 800px at 20% -10%, #1a2340 0%, rgba(26,35,64,0) 60%),
        radial-gradient(1000px 700px at 120% 0%, #321a63 0%, rgba(50,26,99,0) 60%),
        var(--bg);
      color:var(--ink);
      display:flex;flex-direction:column;
    }

    /* NAVBAR */
    .nav{
      width:100%; background:rgba(18,24,41,.6); border-bottom:1px solid var(--line);
      backdrop-filter: blur(6px);
      display:flex; align-items:center; justify-content:center; padding:12px 16px;
      position:sticky; top:0; z-index:40;
    }
    .nav a{color:#fff; text-decoration:none; font-weight:900}
    .nav a:hover{text-decoration:underline}

    /* CONTENIDO */
    .wrap{flex:1; display:grid; place-items:center; padding:24px}
    .card{
      width:100%; max-width:520px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line); border-radius:18px; padding:24px; backdrop-filter: blur(6px);
      box-shadow:0 20px 60px rgba(0,0,0,.35);
    }
    h1{margin:0 0 8px; font-size:26px; font-weight:900; text-align:center}
    .sub{margin:0 0 18px; color:var(--muted); text-align:center; line-height:1.55}
    .field{margin:14px 0 6px}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input[type="email"]{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--line);
      background:#0f1526; color:var(--ink); outline:none; text-align:center;
    }
    input::placeholder{color:#7f8aa3}
    .actions{display:flex; gap:10px; justify-content:center; margin-top:14px; flex-wrap:wrap}
    .btn{
      appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:800;
      background:var(--accent); color:#fff; cursor:pointer; transition:.2s background,.05s transform;
    }
    .btn:hover{background:var(--accent-2)} .btn:active{transform:translateY(1px)}
    .btn.secondary{background:transparent; border:1px solid var(--line); color:var(--ink)}
    .status{margin-top:10px; color:var(--muted); font-size:13px; text-align:center; min-height:20px}

    /* SPINNER */
    .spinner{
      width:18px;height:18px;border-radius:50%;
      border:3px solid rgba(255,255,255,.2); border-top-color:#fff;
      animation:spin .9s linear infinite; display:inline-block; vertical-align:middle; margin-left:8px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* MODAL */
    .modal{position:fixed; inset:0; display:none; place-items:center; padding:20px; background:var(--overlay); z-index:100}
    .modal.visible{display:grid}
    .modal-card{
      width:100%; max-width:720px; background:var(--card); border:1px solid var(--line);
      border-radius:16px; padding:18px 18px 16px; position:relative; box-shadow:0 20px 60px rgba(0,0,0,.55);
    }
    .close{
      position:absolute; top:10px; right:10px; width:38px; height:38px; border-radius:10px;
      display:grid; place-items:center; cursor:pointer; border:1px solid var(--line);
      color:#cfd6ec; background:transparent;
    }
    .close:hover{border-color:#fff; color:#fff}
    .modal-title{margin:0 0 6px; font-weight:900; font-size:20px}
    .modal-body{color:var(--muted); font-size:14px; line-height:1.6}
    .steps{margin:12px 0 4px; padding-left:16px}
    .steps li{margin:6px 0}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; background:#0f1526; padding:2px 6px; border-radius:6px; border:1px solid var(--line); color:#cfd6ec}
    .pill{display:inline-block; font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--line); color:#cfd6ec}
    .callout{margin-top:10px; padding:10px 12px; border:1px dashed var(--line); border-radius:12px; color:#cdd6f4; background:rgba(125,60,255,.08)}
    .modal-actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-top:14px}
  </style>
</head>
<body>
  <!-- NAV -->
  <div class="nav">
    <a href="index.html">Gamification Journey</a>
  </div>

  <!-- CONTENIDO -->
  <div class="wrap">
    <div class="card">
      <h1>Entrar al Dashboard</h1>
      <p class="sub">Pon√© tu correo. Si tu archivo ya est√° listo te llevo directo al <strong>Dashboard</strong>. Si no, te muestro el plan y espero con vos üëÄ.</p>

      <form id="loginForm" novalidate>
        <div class="field">
          <label for="email">Correo</label>
          <input id="email" name="email" type="email" placeholder="tu@email.com" required />
        </div>
        <div class="actions">
          <button id="goBtn" class="btn" type="submit">Continuar</button>
          <a class="btn secondary" href="index.html">Volver al inicio</a>
        </div>
        <div id="status" class="status"></div>
      </form>
    </div>
  </div>

  <!-- MODAL -->
  <section id="awaitModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="modalTitle">
    <div class="modal-card">
      <button id="closeModal" class="close" title="Volver al login">‚úï</button>
      <h2 id="modalTitle" class="modal-title">üïí Preparando tu mundo‚Ä¶</h2>
      <div class="modal-body">
        <p>Te va a llegar un <span class="pill">pergamino digital</span> (un mail) con el link a tu archivo de Google Sheets.</p>
        <ol class="steps">
          <li>Abrilo desde una <strong>PC</strong> y acept√° permisos. Eso activa los <em>triggers</em>.</li>
          <li>Busc√° el bot√≥n <strong>‚öôÔ∏è Gamification</strong> dentro del Sheet (o su men√∫) para iniciar la configuraci√≥n.</li>
          <li>Volv√© a este login y entr√° con tu correo.</li>
          <li>En el Dashboard, hac√© <span class="kbd">Editar Base de Datos</span>:
            agreg√°/quit√°/ajust√° tus <em>tareas</em> por Pilar (Cuerpo / Mente / Alma).</li>
          <li>Presion√° <span class="kbd">Confirmar BBDD</span>. Se genera y guarda tu <strong>Daily Form</strong>.</li>
        </ol>
        <div class="callout">
          <strong>Estado:</strong> estamos esperando que tu URL figure en la <em>columna C</em> de <em>Registros de Usuarios</em>.
          Este cuadro se cierra solo cuando la detectemos ‚úÖ.
        </div>
      </div>
      <div class="modal-actions">
        <a id="signupBtn" href="signup.html" class="btn secondary">Crear cuenta</a>
        <a href="index.html" class="btn secondary">Volver al inicio</a>
        <button id="retryBtn" class="btn secondary" type="button">Reintentar ahora</button>
        <button id="stayBtn" class="btn" type="button">Ok, espero ac√°</button>
      </div>
    </div>
  </section>

  <script>
    // üëâ CAMBIAR por tu WebApp que lee la columna C y responde { ok, has_url, url? }
    const CHECK_ENDPOINT = "https://script.google.com/macros/s/AKfycbzje0wco71mNea1v2WClcpQkvz0Ep3ZIJ8guBONQLvI3G3AXxfpdH0ECaCNMbHHcyJ3Gw/exec";
    const POLL_MS = 10000;

    const $form = document.getElementById('loginForm');
    const $email = document.getElementById('email');
    const $goBtn = document.getElementById('goBtn');
    const $status = document.getElementById('status');

    const $modal = document.getElementById('awaitModal');
    const $close = document.getElementById('closeModal');
    const $retry = document.getElementById('retryBtn');
    const $stay  = document.getElementById('stayBtn');

    let lastEmail = "";
    let pollTimer = null;

    function setStatus(msg, spinning=false){
      $status.innerHTML = spinning ? `${msg} <span class="spinner"></span>` : msg;
    }
    function showModal(){ $modal.classList.add('visible'); $modal.setAttribute('aria-hidden','false'); }
    function hideModal(){ $modal.classList.remove('visible'); $modal.setAttribute('aria-hidden','true'); }
    function disableGo(disabled){
      $goBtn.disabled = disabled;
      $goBtn.style.opacity = disabled ? .7 : 1;
    }

    async function checkStatus(email){
      const res = await fetch(`${CHECK_ENDPOINT}?email=${encodeURIComponent(email)}`, {cache:'no-store'});
      if(!res.ok) throw new Error('Error consultando estado');
      return res.json(); // { ok, has_url, url? }
    }

    function startPolling(){
      stopPolling();
      pollTimer = setInterval(async ()=>{
        try{
          const data = await checkStatus(lastEmail);
          if(data.ok && data.has_url){
            stopPolling(); hideModal();
            // üîí POR REQUERIMIENTO: SI EST√Å LISTO ‚Üí SIEMPRE IR AL DASHBOARD V2
            window.location.href = `dashboardv2.html?email=${encodeURIComponent(lastEmail)}`;
          }
        }catch(_e){ /* seguimos esperando */ }
      }, POLL_MS);
    }
    function stopPolling(){ if(pollTimer){ clearInterval(pollTimer); pollTimer=null; } }

    $form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = $email.value.trim().toLowerCase();
      if(!email || !email.includes('@')){ setStatus('Ingres√° un correo v√°lido.'); return; }
      lastEmail = email;

      disableGo(true);
      setStatus('Chequeando estado‚Ä¶', true);
      try{
        const data = await checkStatus(email);
        if(data.ok && data.has_url){
          setStatus('Listo, entrando‚Ä¶', true);
          window.location.href = `dashboardv2.html?email=${encodeURIComponent(email)}`;
        }else{
          setStatus('Tu archivo a√∫n no est√° listo.');
          showModal(); startPolling();
        }
      }catch(err){
        setStatus('No pudimos chequear ahora. Probemos de nuevo o esperemos un poco.');
        showModal(); startPolling();
      }finally{
        disableGo(false);
      }
    });

    $close.addEventListener('click', ()=>{ stopPolling(); hideModal(); setStatus('Listo para intentar de nuevo.'); });
    $retry.addEventListener('click', async ()=>{
      if(!lastEmail) return;
      setStatus('Reintentando‚Ä¶', true);
      try{
        const data = await checkStatus(lastEmail);
        if(data.ok && data.has_url){
          stopPolling(); hideModal();
          window.location.href = `dashboardv2.html?email=${encodeURIComponent(lastEmail)}`;
        }else{
          setStatus('A√∫n no est√°, seguimos esperando.');
        }
      }catch(_e){ setStatus('Sigue lento. Esperemos un poco m√°s.'); }
    });
    $stay.addEventListener('click', ()=>{/* seguimos con el polling */});

    // Enter para enviar
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && document.activeElement === $email){
        e.preventDefault(); $goBtn.click();
      }
    });
  </script>
</body>
</html>
