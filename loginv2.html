<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Login ‚Äî Gamification Journey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#7d3cff">
  <style>
  /* --- Layout base --- */
  :root{
    --bg: #0b0e14;
    --card: rgba(255,255,255,0.06);
    --card-border: rgba(255,255,255,0.08);
    --text: #E8EAF2;
    --text-dim: #B9BED1;
    --accent: #8e6cff;
    --accent-2: #4ad1ff;
    --chip: rgba(255,255,255,0.08);
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans";
    color:var(--text); background: radial-gradient(1200px 700px at 20% -10%, #251B52 0%, transparent 65%),
                        radial-gradient(900px 600px at 80% 10%, #0A3B53 0%, transparent 60%),
                        var(--bg);
  }
  
  /* Orbes de fondo */
  .bg{ position:fixed; inset:0; pointer-events:none; overflow:hidden;}
  .bg .orb{ position:absolute; filter:blur(60px); opacity:.35; border-radius:50%;}
  .bg .orb.a{ width:380px;height:380px; left:-120px; top:-120px; background:#7c5cff;}
  .bg .orb.b{ width:420px;height:420px; right:-140px; top:-60px; background:#25a4ff;}
  .bg .orb.c{ width:500px;height:500px; left:50%; bottom:-220px; transform:translateX(-50%); background:#4f3d91;}
  
  /* Nav */
  .nav{
    position:sticky; top:0; padding:18px 24px; text-align:center;
    background:linear-gradient(to bottom, rgba(0,0,0,.35), transparent);
    font-weight:700; letter-spacing:.3px;
  }
  .nav a{ color:var(--text); text-decoration:none; }
  
  /* Card ‚Äúglass‚Äù */
  .wrap{ display:grid; place-items:center; padding:56px 20px 80px; }
  .card{
    width:min(720px, 92vw);
    background:linear-gradient(180deg, rgba(255,255,255,.085), rgba(255,255,255,.05));
    border:1px solid var(--card-border);
    border-radius:18px; padding:32px 28px; backdrop-filter: blur(10px);
    box-shadow: 0 10px 40px rgba(0,0,0,.35);
  }
  .card h1{ margin:0 0 10px; font-size:28px; line-height:1.25; }
  .card .sub{ margin:0 0 18px; color:var(--text-dim); }
  
  /* Form */
  .field{ margin:14px 0 16px; }
  .field label{ display:block; font-size:13px; color:var(--text-dim); margin:0 0 6px; }
  .field input{
    width:100%; padding:12px 14px; border-radius:10px;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(255,255,255,0.06); color:var(--text);
    outline:none;
  }
  .actions{ display:flex; gap:10px; margin-top:12px; }
  .btn{
    appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:700; cursor:pointer;
    background:linear-gradient(180deg, #A08BFF, #7F60FF); color:#151221;
    box-shadow:0 6px 22px rgba(127,96,255,.35);
  }
  .btn.secondary{
    background:transparent; color:var(--text);
    border:1px solid rgba(255,255,255,.18);
  }
  .status{ margin-top:10px; min-height:22px; color:var(--text-dim); }
  .spinner{
    display:inline-block; width:16px;height:16px; margin-left:6px;
    border:2px solid rgba(255,255,255,.35); border-top-color:#fff; border-radius:50%;
    animation:spin 0.8s linear infinite; vertical-align:-3px;
  }
  @keyframes spin{ to{ transform:rotate(360deg);} }
  
  /* --- Modal Await (glass card) --- */
  .wait-shell{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:32px 16px;
    background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
    z-index:50;
  }
  .wait-shell.visible{ display:flex; }
  .wait-card{
    width:min(780px, 95vw);
    background:linear-gradient(180deg, rgba(255,255,255,.085), rgba(255,255,255,.05));
    border:1px solid var(--card-border);
    border-radius:18px; padding:26px 22px; backdrop-filter: blur(10px);
    box-shadow: 0 10px 40px rgba(0,0,0,.4);
  }
  .wait-title{ margin:4px 0 8px; font-size:28px; font-weight:800; }
  .wait-sub{ margin:0 0 14px; color:var(--text-dim); }
  .wait-tip{
    margin:10px 0 18px; padding:10px 12px; border-radius:10px;
    background:var(--chip); color:var(--text-dim);
  }
  .wait-section-title{ margin:10px 0 8px; font-size:12px; letter-spacing:.18em; color:var(--text-dim); text-transform:uppercase; }
  
  /* Pasos verticales (no botones) */
  .next-steps{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:10px; }
  .step-row{
    display:flex; align-items:center; gap:12px; padding:12px 14px; border-radius:12px;
    background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08);
  }
  .step-row .num{
    display:inline-grid; place-items:center; width:24px;height:24px; border-radius:999px;
    background:rgba(255,255,255,0.12); font-size:12px; font-weight:800; color:var(--text);
  }
  .step-row .step-text{ color:var(--text); }
  .step-row a{ pointer-events:none; } /* Por si alg√∫n markup heredado */
  
  .wait-minor{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
  .ghost{
    padding:10px 14px; border-radius:999px; background:transparent; color:var(--text);
    border:1px solid rgba(255,255,255,0.2); cursor:pointer; text-decoration:none;
  }
  .close{
    position:absolute; right:14px; top:12px; width:32px; height:32px; border:1px solid rgba(255,255,255,.15);
    background:transparent; color:var(--text); border-radius:10px; cursor:pointer;
  }
  
  /* Modal not-found (usa el mismo overlay que await) */
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:60;
    background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35)); padding:32px 16px;
  }
  .modal.visible{ display:flex; }
  .modal-card{
    width:min(650px, 92vw);
    background:linear-gradient(180deg, rgba(255,255,255,.085), rgba(255,255,255,.05));
    border:1px solid var(--card-border);
    border-radius:18px; padding:22px 20px; backdrop-filter: blur(10px);
  }
  .modal-title{ margin:4px 0 10px; font-size:24px; }
  .modal-actions{ display:flex; gap:10px; margin-top:12px; }

  /* ====== Login: centrar acciones y estado ====== */
  .wrap .actions{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:14px;
  }
  .status{
    text-align:center;
    margin-top:14px;
    min-height:22px; /* reserva lugar cuando no hay mensaje */
  }
  
  /* Spinner compacto y centrable junto al texto de .status */
  .spinner{
    width:1em; height:1em;
    border:2px solid rgba(255,255,255,.28);
    border-top-color:#a78bfa;
    border-radius:50%;
    display:inline-block;
    vertical-align:-2px;
    animation:spin .9s linear infinite;
    margin-left:6px;
  }
  @keyframes spin{ to{ transform:rotate(360deg); } }
  
  /* ====== Await modal: cubrir y desenfocar el fondo ====== */
  .wait-shell{
    position:fixed; inset:0; display:none;
    align-items:center; justify-content:center;
    z-index:1000;
  }
  .wait-shell.visible{ display:flex; }
  
  /* Capa de oscurecimiento + blur para que no ‚Äúse lea‚Äù el login detr√°s */
  .wait-shell::before{
    content:"";
    position:absolute; inset:0;
    background:
      radial-gradient(1200px 800px at 80% 10%, rgba(99,102,241,.18), transparent 70%),
      rgba(8,10,18,.70);                /* <- m√°s opacidad */
    backdrop-filter: blur(12px) saturate(115%);
    -webkit-backdrop-filter: blur(12px) saturate(115%);
  }
  
  /* Tarjeta del modal, un poco m√°s s√≥lida para legibilidad */
  .wait-card{
    position:relative;
    width:min(900px, 92vw);
    padding:28px;
    border-radius:18px;
    background:linear-gradient(180deg, rgba(24,26,35,.90), rgba(24,26,35,.86));
    border:1px solid rgba(255,255,255,.08);
    box-shadow:0 22px 60px rgba(0,0,0,.55);
  }
  
  /* ‚ÄúPr√≥ximos pasos‚Äù: lista vertical, no clicable */
  .next-steps{
    list-style:none;
    margin:10px 0 18px;
    padding:0;
    display:flex;
    flex-direction:column;
    gap:10px;
    counter-reset:step;
  }
  .next-steps li{
    display:flex;
    align-items:center;
    gap:12px;
    padding:14px 16px;
    border-radius:14px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    pointer-events:none;   /* <- NO clickable */
  }
  .next-steps li::before{
    content:counter(step);
    counter-increment:step;
    display:inline-grid;
    place-items:center;
    width:28px; height:28px;
    border-radius:999px;
    background:rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.18);
    font:600 13px/1 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    color:rgba(255,255,255,.92);
  }
  
  /* ‚ÄúMientras tanto‚Äù: centrar chips/botones */
  .wait-minor{
    display:flex;
    justify-content:center;
    flex-wrap:wrap;
    gap:10px;
    margin:8px 0 2px;
  }
  .wait-minor .ghost{
    padding:10px 14px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(255,255,255,.07);
    border-radius:999px;
    transition:transform .08s ease;
  }
  .wait-minor .ghost:active{ transform:scale(.98); }
  
  /* Close del modal, opcional: que siempre quede visible por encima del blur */
  .wait-card .close{ position:absolute; right:12px; top:12px; z-index:1; }
  </style>
</head>
<body>
  <!-- Fondo con destellos (no interact√∫a) -->
  <div class="bg" aria-hidden="true">
    <div class="orb a"></div>
    <div class="orb b"></div>
    <div class="orb c"></div>
  </div>

  <!-- NAV -->
  <div class="nav">
    <a class="brand" href="indexv2.html" aria-label="Innerbloom ‚Äî inicio">
      <img src="https://i.ibb.co/RpyF590p/innerbloom-white.png" alt="" class="logo-mark" width="32" height="32">
      <span class="brand-text">Innerbloom</span>
    </a>
  </div>

  <!-- CONTENIDO (LOGIN) -->
  <div class="wrap" id="loginWrap">
    <div class="card">
      <h1>Entrar al Dashboard</h1>
      <p class="sub">
        Ingres√° tu correo. Si tu base ya est√° lista te llevo directo al
        <strong>Dashboard</strong>. Si no, te muestro los pasos y espero con vos üëÄ.
      </p>

      <form id="loginForm" novalidate>
        <div class="field">
          <label for="email">Correo</label>
          <input id="email" name="email" type="email" placeholder="tu@email.com" required />
        </div>

        <div class="actions">
          <button id="goBtn" class="btn" type="submit">Continuar</button>
          <a class="btn secondary" href="indexv2.html">Volver al inicio</a>
        </div>

        <div id="status" class="status"></div>
      </form>
    </div>
  </div>

  <!-- AWAIT (solo con ?await=1 o cuando el status est√° ‚Äúen proceso‚Äù) -->
  <section id="awaitModal" class="wait-shell" role="dialog" aria-labelledby="awaitTitle" aria-hidden="true">
    <div class="wait-card" role="document">
      <button id="closeModal" class="close" title="Volver al login" aria-label="Volver al login">‚úï</button>

      <h2 id="awaitTitle" class="wait-title">Preparando tu mundo‚Ä¶</h2>
      <p class="wait-sub">
        Estamos creando tu espacio. En unos minutos te llegar√° un
        <strong>pergamino digital</strong> (un mail) para confirmar tu usuario.
      </p>

      <!-- TIP -->
      <div class="wait-tip">
        Tip: revis√° tambi√©n <strong>Spam/Promociones</strong> si el mail no aparece enseguida.
      </div>

      <!-- Pr√≥ximos pasos (vertical, NO botones) -->
      <div class="wait-section-title">Pr√≥ximos pasos</div>
      <ol class="next-steps" aria-label="Pr√≥ximos pasos">
        <li class="step-row"><span class="num">1</span><span class="step-text">Login</span></li>
        <li class="step-row"><span class="num">2</span><span class="step-text">Confirmar BBDD</span></li>
        <li class="step-row"><span class="num">3</span><span class="step-text">Programar Daily&nbsp;Quest</span></li>
      </ol>

      <!-- Mientras tanto (s√≠ accionan) -->
      <div class="wait-section-title">Mientras tanto</div>
      <div class="wait-minor">
        <button id="installBtn"   class="ghost" type="button">Instalar app</button>
        <button id="copyLinkBtn"  class="ghost" type="button">Copiar link</button>
        <a id="signupBtn" class="ghost" href="signupv2.html">Crear cuenta</a>
        <a class="ghost" href="indexv2.html">Volver al inicio</a>
      </div>

      <!-- Ayuda iOS (plegable) -->
      <details id="installHelp" class="wait-tip" style="margin-top:14px;">
        <summary><strong>iPhone (Safari)</strong> ‚Äî ¬øC√≥mo instalar?</summary>
        <ol style="margin:10px 0 0 18px;">
          <li>Toc√° <em>Compartir</em> (icono ‚Üë).</li>
          <li>Eleg√≠ <em>Agregar a inicio</em>.</li>
          <li>Confirm√° el nombre y guard√°.</li>
        </ol>
      </details>
    </div>
  </section>

  <!-- MODAL NOT-FOUND -->
  <section id="notFoundModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="nfTitle">
    <div class="modal-card">
      <button id="closeNF" class="close" title="Cerrar" aria-label="Cerrar">‚úï</button>
      <h2 id="nfTitle" class="modal-title">‚ùå No encontramos tu cuenta</h2>

      <div class="modal-body">
        <p>No hay un usuario registrado con ese correo. Cre√° tu cuenta en un minuto y empez√° tu Journey.</p>
      </div>

      <div class="modal-actions">
        <a id="signupNF" class="btn" href="signupv2.html">Crear cuenta</a>
        <button id="backNF" class="btn secondary" type="button">Volver</button>
      </div>
    </div>
  </section>

  <script>
    /* ================== CONFIG ================== */
    const CHECK_ENDPOINT = "https://script.google.com/macros/s/AKfycbzOvVEFFtNQfFE28AK5Tgi7kwdzn4if5tbLHofmlyAQ3fiVLdQgwXah2TcqTZDLEzua/exec";
    const POLL_MS = 10000;
    const DASHBOARD = "dashboardv3.html";

    /* ================== UTILS ================== */
    function qs(n){ const p=new URLSearchParams(location.search); return (p.get(n)||"").trim(); }
    function setStatus(msg, spinning=false){
      const $status = document.getElementById('status');
      if (!$status) return;
      $status.innerHTML = spinning ? `${msg} <span class="spinner" aria-hidden="true"></span>` : msg;
    }
    function showModal(id){
      const m=document.getElementById(id); if(!m) return;
      m.classList.add('visible'); m.setAttribute('aria-hidden','false');
    }
    function hideModal(id){
      const m=document.getElementById(id); if(!m) return;
      m.classList.remove('visible'); m.setAttribute('aria-hidden','true');
    }
    function disable(el,v){ if(!el) return; el.disabled = !!v; el.style.opacity = v ? 0.7 : 1; }

    function hideLogin(){
      const w = document.getElementById('loginWrap');
      if (w){ w.hidden = true; w.setAttribute('aria-hidden','true'); }
    }
    function showLogin(){
      const w = document.getElementById('loginWrap');
      if (w){ w.hidden = false; w.setAttribute('aria-hidden','false'); }
    }

    const UA = navigator.userAgent || '';
    const isIOS = /iPhone|iPad|iPod/i.test(UA);
    const isAndroid = /Android/i.test(UA);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;

    /* ================== CHECKER ================== */
    async function checkStatus(email){
      const res = await fetch(`${CHECK_ENDPOINT}?email=${encodeURIComponent(email)}`, {cache:'no-store'});
      if (res.status === 404) return { ok:false, notFound:true };
      let data = {};
      try { data = await res.json(); } catch { data = {}; }
      if (data && data.notFound) return { ok:false, notFound:true };
      return data;
    }
    function isReady(d){ return d && d.ok && (d.has_url || d.ready); }
    function isNotFound(d){
      if (!d) return false;
      if (d.notFound === true) return true;
      const m = (d.message||d.error||d.reason||'').toString().toLowerCase();
      return /no existe|not found|no encontrado/.test(m);
    }

    /* ================== LOGIN FLOW ================== */
    let pollTimer=null, lastEmail="";
    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const $goBtn = document.getElementById('goBtn');
      const email = (document.getElementById('email').value||"").trim().toLowerCase();
      if(!email || !email.includes('@')){ setStatus('Ingres√° un correo v√°lido.'); return; }
      lastEmail=email;

      if(!CHECK_ENDPOINT || CHECK_ENDPOINT.startsWith("PON_AQUI")) {
        hideLogin();
        showModal('awaitModal');
        return;
      }

      disable($goBtn,true); setStatus('Chequeando estado‚Ä¶', true);
      try{
        const data = await checkStatus(email);

        // Usuario no existe
        if (isNotFound(data)){
          setStatus('Ese correo no est√° registrado.');
          hideModal('awaitModal'); // por si estaba abierto
          showModal('notFoundModal');
          const $f = document.getElementById('signupNF'); if ($f) $f.focus();
          return;
        }

        // Listo ‚Üí entrar
        if (isReady(data)){
          setStatus('Listo, entrando‚Ä¶', true);
          window.location.href = `${DASHBOARD}?email=${encodeURIComponent(email)}`;
          return;
        }

        // En proceso ‚Üí esperar (oculta login)
        setStatus('Tu base est√° en proceso. Te avisamos ac√°.');
        hideLogin();
        showModal('awaitModal');
        startPolling();

      }catch(_){
        setStatus('Est√° lento. Te muestro los pasos y seguimos chequeando‚Ä¶');
        hideLogin();
        showModal('awaitModal');
        startPolling();
      }finally{
        disable($goBtn,false);
      }
    });

    function startPolling(){
      stopPolling();
      pollTimer=setInterval(async ()=>{
        try{
          const data = await checkStatus(lastEmail);
          if (isNotFound(data)){
            stopPolling(); hideModal('awaitModal'); showLogin();
            setStatus('Ese correo no est√° registrado.');
            showModal('notFoundModal');
            return;
          }
          if (isReady(data)){
            stopPolling(); hideModal('awaitModal');
            window.location.href = `${DASHBOARD}?email=${encodeURIComponent(lastEmail)}`;
          }
        }catch(_){}
      }, POLL_MS);
    }
    function stopPolling(){ if(pollTimer){ clearInterval(pollTimer); pollTimer=null; } }

    // Cierres / acciones modales
    document.getElementById('closeModal')
      .addEventListener('click', ()=>{
        stopPolling();
        hideModal('awaitModal');
        showLogin();
        setStatus('Listo para intentar de nuevo.');
      });

    const retry = document.getElementById('retryBtn');
    if (retry){
      retry.addEventListener('click', async ()=>{
        if(!lastEmail) return;
        const t = retry.textContent;
        retry.innerHTML = `Reintentando <span class="spinner" aria-hidden="true"></span>`;
        retry.disabled = true;
        try{
          const data = await checkStatus(lastEmail);
          if (isNotFound(data)){
            stopPolling(); hideModal('awaitModal'); showLogin();
            setStatus('Ese correo no est√° registrado.');
            showModal('notFoundModal');
            return;
          }
          if (isReady(data)){
            stopPolling(); hideModal('awaitModal');
            window.location.href = `${DASHBOARD}?email=${encodeURIComponent(lastEmail)}`;
          }
        }catch(_){/* noop */}
        finally{
          retry.textContent = t;
          retry.disabled = false;
        }
      });
    }

    document.getElementById('closeNF')?.addEventListener('click', ()=> hideModal('notFoundModal'));
    document.getElementById('backNF')?.addEventListener('click', ()=> hideModal('notFoundModal'));

    // Modo ‚Äúforzar popup‚Äù desde el mail (await=1)
    (function boot(){
      // En iOS mostramos de entrada el bot√≥n Instalar (abre ayuda)
      const $installBtn = document.getElementById('installBtn');
      if (isIOS && $installBtn) $installBtn.style.display = 'inline-block';

      const force = qs('await');
      const pre = qs('email');
      if (pre) document.getElementById('email').value = pre;

      if (force === '1') {
        hideLogin();                 // ‚¨ÖÔ∏è importante
        showModal('awaitModal');
        if (pre && CHECK_ENDPOINT && !CHECK_ENDPOINT.startsWith("PON_AQUI")){
          lastEmail = pre.toLowerCase();
          startPolling();
        }
      }
    })();

    // Enter directo
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && document.activeElement === document.getElementById('email')){
        e.preventDefault(); document.getElementById('goBtn').click();
      }
    });

    /* ================== PWA: Instalar / Copy link ================== */
    const $installBtn = document.getElementById('installBtn');
    const $copyLinkBtn = document.getElementById('copyLinkBtn');
    const $installHelp = document.getElementById('installHelp');
    let deferredPrompt = null;

    window.addEventListener('beforeinstallprompt', (e) => {
      if (isStandalone) return;
      e.preventDefault();
      deferredPrompt = e;
      if ($installBtn) $installBtn.style.display = 'inline-block';
    });

    $installBtn?.addEventListener('click', async ()=>{
      if (deferredPrompt) {
        deferredPrompt.prompt();
        try { await deferredPrompt.userChoice; } catch {}
        deferredPrompt = null;
        return;
      }
      if (isIOS) {
        if ($installHelp) $installHelp.style.display = 'block';
        return;
      }
      alert('Si tu navegador lo permite, us√° ‚ÄúInstalar app / Agregar a la pantalla de inicio‚Äù.');
    });

    function buildPortalUrlForMobile(){
      const base = `${location.origin}${location.pathname}`;
      const email = (document.getElementById('email').value||'').trim().toLowerCase();
      const params = new URLSearchParams({ await:'1' });
      if (email) params.set('email', email);
      return `${base}?${params.toString()}`;
    }

    $copyLinkBtn?.addEventListener('click', async ()=>{
      const url = buildPortalUrlForMobile();
      try{
        await navigator.clipboard.writeText(url);
        const old = $copyLinkBtn.textContent;
        $copyLinkBtn.textContent = 'Copiado ‚úì';
        setTimeout(()=> $copyLinkBtn.textContent = old, 1400);
      }catch{
        prompt('Copi√° este link:', url);
      }
    });
  </script>

  <!-- SW -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js', { scope: './' })
          .then(r => console.log('[SW] registrado', r.scope))
          .catch(e => console.error('[SW] error', e));
      });
    }
  </script>
</body>
</html>

