<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Self-Improvement Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Fuente + CSS (en carpeta /css) -->
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/dashboardv3.css?v=3">
  <!-- Libs de charts ANTES de tu JS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>
<body>
  <!-- SPINNER -->
  <div id="spinner-overlay">
    <div class="spinner"></div>
  </div>

  <!-- HEADER -->
  <header>
    <div class="logo">🎮 Gamification Life Journey</div>
    <div class="menu-toggle" id="menu-toggle">☰</div>
  </header>
 
  <!-- MENÚ HAMBURGUESA -->
  <nav id="dashboard-menu">
    <ul>
      <li><a href="#" id="edit-avatar">Cambiar tu avatar</a></li>
      <li><a href="#" id="edit-bbdd-menu" data-link="editar-base">Editar Base</a></li>
      <li><a href="gamificationweblanding/index-bbdd.html" id="edit-bbdd-menu" data-keep-email>Editar Base(beta)</a></li>
      <li><a href="#" id="daily-quest">Daily Quest</a></li>
      <li><a href="#" id="open-scheduler">Programar Daily Quest</a></li>
      <li><a href="#" id="refresh-kv" data-action="refresh-kv">Actualizar</a></li>
      <li><a href="indexv2.html">Cerrar sesión</a></li>
    </ul>
  </nav>

  <!-- LAYOUT -->
  <main>
    <div class="dashboard-content">
      <div class="dashboard-columns">
        <!-- IZQUIERDA -->
        <section class="left-column">
          <!-- XP + Level -->
          <div class="xp-box">
            <div class="card-title">
              <button class="info-chip" aria-controls="info-xp" aria-expanded="false" title="Ayuda">ⓘ</button>
              <h3>🏆 Total XP: <span id="xp-actual">0</span> · 🎯 Level: <span id="nivel-actual">0</span></h3>
            </div>
            <div class="info-pop" id="info-xp" role="tooltip" hidden>
              <strong>¿Qué ves acá?</strong>
              <ul>
                <li>🏆 <b>XP</b> = experiencia total acumulada.</li>
                <li>🎯 <b>Level</b> sube al alcanzar el umbral de XP.</li>
                <li>📊 La barra muestra el <b>progreso al próximo nivel</b>.</li>
                <li>💡 Tip: cada hábito completado suma XP. ¡Pequeños pasos, gran avance!</li>
              </ul>
              <button class="info-close" aria-label="Cerrar">✕</button>
            </div>
            <div class="progress-bar"><div id="bar-nivel" class="bar-fill nivel"></div></div>
            <p>✨ Te faltan <span id="xp-faltante">0</span> XP para el próximo nivel</p>
          </div>
          
          <div class="avatar-box">
            <img id="avatar" class="avatar-img" src="" alt="Avatar">
          </div>

          <!-- Daily Energy -->
          <div class="energy-box">
            <div class="card-title">
              <button class="info-chip" aria-controls="info-energy" aria-expanded="false" title="Ayuda">ⓘ</button>
              <h3>💠 Daily Energy</h3>
            </div>
            <div class="info-pop" id="info-energy" role="tooltip" hidden>
              <strong>¿Qué es Daily Energy?</strong>
              <ul>
                <li>🫀 <b>HP</b> → ligado a Body.</li>
                <li>🏵️ <b>Mood</b> → ligado a Soul.</li>
                <li>🧠 <b>Focus</b> → ligado a Mind.</li>
                <li>🔋 Se cargan según tus actividades diarias (últimos 7 días).</li>
                <li>💡 Mantenerlas altas te motiva y da constancia.</li>
              </ul>
              <button class="info-close" aria-label="Cerrar">✕</button>
            </div>
            <div class="energy-meter">
              <span class="energy-label">HP</span>
              <div class="energy-track"><div id="bar-hp" class="bar-fill hp"></div></div>
            </div>
            <div class="energy-meter">
              <span class="energy-label">Mood</span>
              <div class="energy-track"><div id="bar-mood" class="bar-fill mood"></div></div>
            </div>
            <div class="energy-meter">
              <span class="energy-label">Focus</span>
              <div class="energy-track"><div id="bar-focus" class="bar-fill focus"></div></div>
            </div>
          </div>
          
          <!-- Daily Cultivation -->
          <div class="daily-cultivation-section">
            <div class="daily-cultivation-header">
              <div class="card-title">
                <h3>🪴 Daily Cultivation</h3>
                <button class="info-chip" aria-controls="info-cultivation" aria-expanded="false" title="Ayuda">ⓘ</button>
              </div>
              <div class="info-pop" id="info-cultivation" role="tooltip" hidden>
                <strong>¿Qué es Daily Cultivation?</strong>
                <ul>
                  <li>📈 Muestra los <b>puntos de XP</b> que ganaste cada día del mes.</li>
                  <li>📊 Te ayuda a ver que el progreso <b>no siempre es lineal</b>.</li>
                  <li>💡 Está bien tener altibajos, lo importante es la constancia.</li>
                </ul>
                <button class="info-close" aria-label="Cerrar">✕</button>
              </div>
              <label for="month-select">Mes:</label>
              <select id="month-select"></select>
            </div>
            <div class="chart-wrapper">
              <canvas id="xpChart"></canvas>
            </div>
          </div>
        </section>

        <!-- CENTRO -->
        <section class="center-column">
          <div id="journey-warning" class="warning-container" style="display:none;">
            <p class="warning-text">⚠️ Te falta completar tu formulario inicial para comenzar tu Journey.</p>
            <a href="https://rfullivarri.github.io/gamificationweblanding/formsintro.html" class="dashboard-button">Realizar formulario</a>
          </div>

          <!-- AVISO: Falta confirmar BBDD -->
          <div id="bbdd-warning" class="warning-container" style="display:none;">
            <p class="warning-text">⚙️ Te falta confirmar tu base de datos. Abrí el menú (☰) → “Editar Base”, revisala y presioná “Confirmar Edicion”.</p>
            <a id="edit-bbdd-warning" href="#" class="dashboard-button">Editar Base</a>
            <a id="edit-bbdd-warning" href="gamificationweblanding/index-bbdd.html" class="dashboard-button" data-keep-email>Editar Base(Beta)</a>
          </div>

          <!-- Radar -->
          <div class="radar-section">
            <div class="card-title">
              <button class="info-chip" aria-controls="info-radar" aria-expanded="false" title="Ayuda">ⓘ</button>
              <h3>🧿 Radar Chart</h3>
            </div>
            <div class="info-pop" id="info-radar" role="tooltip" hidden>
              <strong>¿Qué es el Radar Chart?</strong>
              <ul>
                <li>📊 Muestra tus <b>rasgos principales</b> en Body, Mind y Soul.</li>
                <li>🧭 Cada punto refleja XP acumulada en ese rasgo.</li>
                <li>💡 Sirve para ver tu <b>balance general</b> y detectar desequilibrios.</li>
              </ul>
              <button class="info-close" aria-label="Cerrar">✕</button>
            </div>
            <div id="radarChartContainer"><canvas id="radarChart"></canvas></div>
          </div>

          <!-- Emotion Chart -->
          <div class="emotion-box">
            <div class="card-title">
              <button class="info-chip" aria-controls="info-emotion" aria-expanded="false" title="Ayuda">ⓘ</button>
              <h3>💗 Emotion Chart</h3>
            </div>
            <div class="info-pop" id="info-emotion" role="tooltip" hidden>
              <strong>¿Qué es el Emotion Chart?</strong>
              <ul>
                <li>💗 Registra tus <b>emociones diarias</b>.</li>
                <li>📅 Te permite ver cómo <b>fuiste sintiéndote</b> a lo largo del tiempo.</li>
                <li>💡 Detectar patrones emocionales ayuda a mejorar tu Journey.</li>
              </ul>
              <button class="info-close" aria-label="Cerrar">✕</button>
            </div>
            <div class="emotion-legend">
              <span><span class="color-box" style="background-color:#2ECC71;"></span>Calma</span>
              <span><span class="color-box" style="background-color:#F1C40F;"></span>Felicidad</span>
              <span><span class="color-box" style="background-color:#9B59B6;"></span>Motivación</span>
              <span><span class="color-box" style="background-color:#3498DB;"></span>Tristeza</span>
              <span><span class="color-box" style="background-color:#E74C3C;"></span>Ansiedad</span>
              <span><span class="color-box" style="background-color:#8D6E63;"></span>Frustración</span>
              <span><span class="color-box" style="background-color:#16A085;"></span>Cansancio</span>
            </div>
            <div id="emotionChart" class="emotion-chart-container"></div>
            <div id="emotion-destacada"></div>
          </div>
        </section>

        <!-- DERECHA -->
        <section class="right-column">
          <!-- 🔥 DOPAMINE PILLAR CARD (columna 3) -->
          <div id="pillar-card-root" class="pc-card"></div>
          <div id="rewardsContainer"></div>
        </section>
      </div>
    </div>
  </main>

  <!-- Misiones -->
  <section class="missions-section">
    <h3>🗂️ Misiones</h3>
    <div id="missions-wrapper" class="missions-grid"></div>
  </section>
  
  <!-- Popup Cambiar Avatar -->
  <div id="avatarPopup" class="popup-overlay">
    <div class="popup-content">
      <button class="close-btn" id="closeAvatarPopup">✕</button>
      <h3>📷 Cambiar tu Avatar</h3>
  
      <img id="currentAvatar" src="" alt="Avatar actual" class="avatar-preview" />
      <input type="file" id="newAvatarInput" accept="image/*" />
  
      <div class="popup-buttons">
        <button id="cancelAvatar" class="btn cancel">Cancelar</button>
        <button id="confirmAvatar" class="btn confirm">Confirmar</button>
      </div>
      <div id="avatarStatus" style="margin-top:10px;font-size:13px;opacity:.8"></div>
    </div>
  </div>
  
  <!-- Tu JS al final -->
  <script src="js/dashboardv3.js?v=3"></script>
  <script type="module" src="js/scheduler-controller.js?v=3"></script>

  <!-- (Opcional) helper para mantener email en links marcados -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const url = new URL(location.href);
      let email = (url.searchParams.get('email') || localStorage.getItem('gj_email') || '').trim().toLowerCase();
      if (!email) return;

      document.querySelectorAll('a[data-keep-email]').forEach(a => {
        const u = new URL(a.getAttribute('href'), location.origin);
        u.searchParams.set('email', email);
        a.setAttribute('href', u.toString());
      });
    });
  </script>
</body>
</html>
